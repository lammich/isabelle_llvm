<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/ATP/atp_problem_generate.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/ATP/atp_problem_generate.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/ATP/atp_problem_generate.ML
    Author:     Fabian Immler, TU Muenchen
    Author:     Makarius
    Author:     Jasmin Blanchette, TU Muenchen
    Author:     Martin Desharnais, UniBw Muenchen

Translation of HOL to FOL for Metis and Sledgehammer.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ATP_PROBLEM_GENERATE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_term</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>atp_connective</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_connective</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>atp_format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_format</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>atp_formula_role</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_formula_role</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> 'a </span><span class="entity"><span>atp_problem</span></span><span> </span><span class="main"><span>=</span></span><span> 'a </span><span class="entity"><span>ATP_Problem.atp_problem</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Metis</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sledgehammer</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sledgehammer_Completish</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Exporter</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Translator</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Global</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Local</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assum</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Chained</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>General</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Induction</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Intro</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Inductive</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Elim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Simp</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Rec_Def</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>scope</span></span><span> * </span><span class="entity"><span>status</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Strict</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Strict</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>uniformity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Uniform</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ctr_optim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>With_Ctr_Optim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Without_Ctr_Optim</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>type_level</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>All_Types</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> strictness * uniformity </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctr_optim </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>No_Types</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_lamsN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> opaque_liftingN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> liftingN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> opaque_combsN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> combsN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> combs_and_liftingN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> combs_or_liftingN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> keep_lamsN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> schematic_var_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fixed_var_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tvar_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tfree_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> const_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_const_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> class_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lam_lifted_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lam_lifted_mono_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lam_lifted_poly_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> skolem_const_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> old_skolem_const_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> new_skolem_const_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> combinator_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> class_decl_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_decl_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sym_decl_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> datatype_decl_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> class_memb_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guards_sym_formula_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tags_sym_formula_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fact_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conjecture_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> helper_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subclass_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tcon_clause_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tfree_clause_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lam_fact_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typed_helper_suffix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> untyped_helper_suffix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> predicator_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> app_op_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_guard_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_tag_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> native_type_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prefixed_predicator_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prefixed_app_op_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prefixed_type_tag_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ascii_of </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unascii_of </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unprefix_and_unascii </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> proxy_table </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> proxify_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invert_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unproxify_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> new_skolem_var_name_of_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_logical_consts </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_irrelevant_consts </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_widely_irrelevant_consts </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_irrelevant_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_widely_irrelevant_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_schematic_consts_of </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_type_enc_higher_order </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_type_enc_polymorphic </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> level_of_type_enc </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_level</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_type_enc_sound </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_enc_of_string </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> adjust_type_enc </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_first_order_lambda_free </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> do_cheaply_conceal_lambdas </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_aconns </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>atp_connective</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>,</span></span><span> 'c</span><span class="main"><span>,</span></span><span> 'd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unmangled_type </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ATP_Problem.atp_term</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unmangled_const </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span class="main"><span>,</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_term</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unmangled_const_name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> helper_table </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>status</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trans_lams_of_string </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_status </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> factsN </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> generate_atp_problem </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>atp_format</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>atp_formula_role</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_problem</span></span><span> * </span><span>string</span><span> </span><span>Symtab.table</span><span>
    * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>int</span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atp_problem_term_order_info </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="entity"><span>atp_problem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>ATP_Problem_Generate</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ATP_PROBLEM_GENERATE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Metis</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sledgehammer</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sledgehammer_Completish</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Exporter</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Translator</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Global</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Local</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assum</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Chained</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>General</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Induction</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Intro</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Inductive</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Elim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Simp</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Rec_Def</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>scope</span></span><span> * </span><span class="entity"><span>status</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>order</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>First_Order</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thf_flavor
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>phantom_policy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Without_Phantom_Type_Vars</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>With_Phantom_Type_Vars</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>polymorphism</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> phantom_policy </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Raw_Monomorphic</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Mangled_Monomorphic</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Strict</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Strict</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>uniformity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Uniform</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ctr_optim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>With_Ctr_Optim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Without_Ctr_Optim</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>type_level</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>All_Types</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> strictness * uniformity </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> ctr_optim </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>No_Types</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Native</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> order * fool * polymorphism * type_level </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Guards</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> polymorphism * type_level </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Tags</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> polymorphism * type_level

</span><span class="comment1"><span>(* not clear whether ATPs prefer to have their negative variables tagged *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tag_neg_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_enc_native</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="entity"><span>THF_Lambda_Free</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_type_enc_choice</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="entity"><span>THF_With_Choice</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_type_enc_choice</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_type_enc_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>with_ite</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_ite</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_type_enc_ite</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_type_enc_let</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>with_let</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_let</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_type_enc_let</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_enc_mangling</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_level_sound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Const_Types</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_level_sound</span></span><span> </span><span class="entity"><span>No_Types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_level_sound</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_type_enc_sound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_level_sound</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_level_monotonicity_based</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_type_level_monotonicity_based</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_lamsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"no_lams"</span></span><span> </span><span class="comment1"><span>(* used internally; undocumented *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opaque_liftingN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"opaque_lifting"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>liftingN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"lifting"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opaque_combsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"opaque_combs"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>combsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"combs"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>combs_and_liftingN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"combs_and_lifting"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>combs_or_liftingN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"combs_or_lifting"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keep_lamsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"keep_lams"</span></span><span>

</span><span class="comment1"><span>(* The capitalization of the TPTP output respects the capitalzation of the prefix. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"B_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>let_bound_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"l_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_bound_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"A_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exist_bound_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"E_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematic_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"V_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixed_var_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"v_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"T_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfree_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tf_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"t_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>native_type_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"n_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"cl_"</span></span><span>

</span><span class="comment1"><span>(* Freshness almost guaranteed! *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ATP"</span></span><span> </span><span>^</span><span> </span><span>Long_Name.separator</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_weak_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ATP:"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_weak_suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>":ATP"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_weak_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"Lam"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_lifted_mono_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"m"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_lifted_poly_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"p"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolem_const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"Sko"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_skolem_const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skolem_const_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"o"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_skolem_const_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skolem_const_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"n"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"COMB"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_decl_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"cl_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_decl_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ty_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym_decl_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sy_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatype_decl_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"dt_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_memb_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"cm_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>guards_sym_formula_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"gsy_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tags_sym_formula_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tsy_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncurried_alias_eq_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"unc_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"fact_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjecture_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"conj_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>helper_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"help_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subclass_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"subcl_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tcon_clause_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tcon_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfree_clause_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tfree_"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_fact_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ATP.lambda_"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typed_helper_suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_T"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>untyped_helper_suffix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_U"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predicator_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"pp"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"aa"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_guard_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"gg"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_tag_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"tt"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefixed_predicator_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>predicator_name</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefixed_app_op_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>app_op_name</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefixed_type_tag_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>type_tag_name</span></span><span>

</span><span class="comment1"><span>(*Escaping of special characters.
  Alphanumeric characters are left unchanged.
  The character _ goes to __.
  Characters in the range ASCII space to / go to _A to _P, respectively.
  Other characters go to _nnn where nnn is the decimal ASCII code. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upper_a_minus_space</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Char.ord</span><span> </span><span class="inner_quoted"><span>#"A"</span></span><span> </span><span>-</span><span> </span><span>Char.ord</span><span> </span><span class="inner_quoted"><span>#" "</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ascii_of_char</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Char.isAlphaNum</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>String.str</span><span> </span><span class="entity"><span>c</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="inner_quoted"><span>"__"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_quoted"><span>#" "</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_quoted"><span>#"/"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>String.str</span><span> </span><span class="main"><span>(</span></span><span>Char.chr</span><span> </span><span class="main"><span>(</span></span><span>Char.ord</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>upper_a_minus_space</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="comment1"><span>(* fixed width, in case more digits follow *)</span></span><span>
    </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>stringN_of_int</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="main"><span>(</span></span><span>Char.ord</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.translate</span><span> </span><span class="entity"><span>ascii_of_char</span></span><span>

</span><span class="comment1"><span>(** Remove ASCII armoring from names in proof files **)</span></span><span>

</span><span class="comment1"><span>(* We don't raise error exceptions because this code can run inside a worker
   thread. Also, the errors are impossible. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unascii_of</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="entity"><span>rcs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.implode</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="entity"><span>rcs</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>#"_"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(* ERROR *)</span></span><span>
        </span><span class="comment1"><span>(* Three types of _ escapes: __, _A to _P, _nnn *)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="entity"><span>rcs</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="entity"><span>rcs</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_quoted"><span>#"A"</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>c</span></span><span>&lt;=</span><span> </span><span class="inner_quoted"><span>#"P"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="comment1"><span>(* translation of #" " to #"/" *)</span></span><span>
          </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span>Char.chr</span><span> </span><span class="main"><span>(</span></span><span>Char.ord</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>upper_a_minus_space</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>digits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>General.Subscript</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Int.fromString</span><span> </span><span class="main"><span>(</span></span><span>String.implode</span><span> </span><span class="entity"><span>digits</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span>Char.chr</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="inner_quoted"><span>#"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="comment1"><span>(* ERROR *)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="entity"><span>rcs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rcs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>un</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>String.explode</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* If string s has the prefix s1, return the result of deleting it,
   un-ASCII'd. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unascii_of</span></span><span> </span><span class="main"><span>(</span></span><span>String.extract</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>size</span><span> </span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proxy_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_False"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fFalse_def|fact"><span>fFalse_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fFalse"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fFalse|const"><span>fFalse</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_True"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue_def|fact"><span>fTrue_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fTrue"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue|const"><span>fTrue</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_Not"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fNot_def|fact"><span>fNot_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fNot"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fNot|const"><span>fNot</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_conj"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_def|fact"><span>fconj_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fconj"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj|const"><span>fconj</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_disj"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_def|fact"><span>fdisj_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fdisj"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj|const"><span>fdisj</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_implies"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies_def|fact"><span>fimplies_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fimplies"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies|const"><span>fimplies</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"equal"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal_def|fact"><span>fequal_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fequal"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal|const"><span>fequal</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_All"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll_def|fact"><span>fAll_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fAll"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll|const"><span>fAll</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_Ex"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx_def|fact"><span>fEx_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fEx"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx|const"><span>fEx</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"c_Choice"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Hilbert_Choice.html#Hilbert_Choice.Eps|const"><span>Hilbert_Choice.Eps</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fChoice_def|fact"><span>fChoice_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fChoice"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fChoice|const"><span>fChoice</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proxify_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proxy_table</span></span><span> </span><span>#&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Readable names for the more common symbolic functions. Do not mess with the
   table unless you know what you are doing. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_trans_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"False"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"True"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Not"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"conj"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"disj"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"implies"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"equal"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"All"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Ex"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"If"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.member|const"><span>Set.member</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"member"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>HOL.Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Let"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Hilbert_Choice.html#Hilbert_Choice.Eps|const"><span>Hilbert_Choice.Eps</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Choice"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBI|const"><span>Meson.COMBI</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"I"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBK|const"><span>Meson.COMBK</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"K"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBB|const"><span>Meson.COMBB</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"B"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBC|const"><span>Meson.COMBC</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"C"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBS|const"><span>Meson.COMBS</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combinator_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"S"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Symtab.make</span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span>o</span><span> </span><span>swap</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proxy_table</span></span><span>

</span><span class="comment1"><span>(* Invert the table of translations between Isabelle and ATPs. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_trans_table_inv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>const_trans_table</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>swap</span><span> </span><span>|&gt;</span><span> </span><span>Symtab.make</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_trans_table_unprox</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.empty</span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isa</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proxy_table</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>invert_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>const_trans_table_inv</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unproxify_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>const_trans_table_unprox</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>const_trans_table</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ascii_of_indexname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>v</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ascii_of_indexname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_bound_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_all_bound_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_bound_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_exist_bound_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exist_bound_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_schematic_var</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>schematic_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of_indexname</span></span><span> </span><span class="entity"><span>v</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fixed_var</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixed_var_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_tvar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of_indexname</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unquote_tvar</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_tfree</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfree_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unquote_tvar</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tvar_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_tvar</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* "HOL.eq" and choice are mapped to the ATP's equivalents *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_old_equal</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lookup_const</span></span><span> </span><span class="entity"><span>c</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fixed_type_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_const_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lookup_const</span></span><span> </span><span class="entity"><span>c</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>clas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>clas</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_skolem_var_name_of_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.explode</span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* These are ignored anyway by the relevance filter (unless they appear in
   higher-order places) but not by the monomorphizer. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_logical_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.prop</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.conjunction</span><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(* These are either simplified away by "Meson.presimplify" (most of the time) or
   handled specially via "fFalse", "fTrue", ..., "fequal". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_irrelevant_consts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_widely_irrelevant_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_logical_consts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>atp_irrelevant_consts</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_irrelevant_const_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_irrelevant_consts</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_widely_irrelevant_const_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_widely_irrelevant_consts</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_irrelevant_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>atp_irrelevant_const_tab</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_widely_irrelevant_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>atp_widely_irrelevant_const_tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_schematic_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Monomorph.typ_has_tvars</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>?</span><span> </span><span>Symtab.insert_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_schematic_consts_of</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_widely_irrelevant_const</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>add_schematic_const</span></span><span> </span><span class="entity"><span>x</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>Symtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_a_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"'a"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_a_z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_a_str</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>tvar_a_z</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_a_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_name</span></span><span> </span><span class="entity"><span>tvar_a_z</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>itself_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_type_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>itself</span><span>›</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TYPE_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.type</span><span>›</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_a_atype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_a_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_itself_atype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>itself_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tvar_a_atype</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Definitions and functions for FOL clauses and formulas for TPTP **)</span></span><span>

</span><span class="comment1"><span>(** Type class membership **)</span></span><span>

</span><span class="comment1"><span>(* In our data structures, [] exceptionally refers to the top class, not to
   the empty class. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_of_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_classes</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>class_of_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>cls</span></span><span>

</span><span class="comment1"><span>(* Arity of type constructor "s :: (arg1, ..., argN) res" *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_axiom_tcon_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>normalize_classes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_a_str</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Generate all pairs (tycon, class, sorts) such that tycon belongs to class in
   theory thy provided its arguments have the corresponding sorts. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>domain_sorts</span></span><span> </span><span class="entity"><span>tycon</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.mg_domain</span><span> </span><span class="entity"><span>alg</span></span><span> </span><span class="entity"><span>tycon</span></span><span> </span><span>o</span><span> </span><span>single</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_class</span></span><span> </span><span class="entity"><span>tycon</span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>domain_sorts</span></span><span> </span><span class="entity"><span>tycon</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Sorts.CLASS_ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_classes</span></span><span> </span><span class="entity"><span>tycon</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tycon</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_class</span></span><span> </span><span class="entity"><span>tycon</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>try_classes</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Proving one (tycon, class) membership may require proving others, so
   iterate. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_class_pairs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>all_class_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="entity"><span>old_cls</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_cls'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>old_cls</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_insert_class</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_cls'</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="entity"><span>cls</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_cls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>maybe_insert_class</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pairs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_class_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="entity"><span>old_cls'</span></span><span> </span><span class="entity"><span>new_cls</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pairs'</span></span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>rest</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ars</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_of_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ars</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="comment1"><span>(* multiple clauses for the same (tycon, cl) pair *)</span></span><span>
      </span><span class="entity"><span>make_axiom_tcon_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>lookup_const</span></span><span> </span><span class="entity"><span>tcons</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"___"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ar</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ars</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>make_axiom_tcon_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_const</span></span><span> </span><span class="entity"><span>tcons</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"___"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ar</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tcons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ars</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_tcon_clauses</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>all_class_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>##&gt;</span><span> </span><span class="entity"><span>tcon_clause</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>


</span><span class="comment1"><span>(** Isabelle class relations **)</span></span><span>

</span><span class="comment1"><span>(* Generate a list ("sub", "supers") such that "sub" is a proper subclass of all
   "supers". *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_subclass_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>supers</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_less</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Sorts.class_less</span><span> </span><span class="main"><span>(</span></span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>supers_of</span></span><span> </span><span class="entity"><span>sub</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_less</span></span><span> </span><span class="entity"><span>sub</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>supers</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>supers_of</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* intermediate terms *)</span></span><span>
</span><span class="comment1"><span>(* TODO: Merge IConst and IVar *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>IConst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * string</span><span class="main"><span>)</span></span><span> * typ * typ list </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>IVar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * string</span><span class="main"><span>)</span></span><span> * typ </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>IApp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> iterm * iterm </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>IAbs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * string</span><span class="main"><span>)</span></span><span> * typ</span><span class="main"><span>)</span></span><span> * iterm

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>alpha_rename</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="entity"><span>to</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="entity"><span>tm1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="entity"><span>tm2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm1'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>tm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>traverse</span></span><span> </span><span class="entity"><span>tm1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm1'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm1'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>traverse</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>dest_funT</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>tm</span></span><span>

</span><span class="comment1"><span>(*gets the head of a combinator application, along with the list of arguments*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>stripc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_atyps</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_skolem_const_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>num_T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="entity"><span>new_skolem_const_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>num_T_args</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Long_Name.implode</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alpha_to_beta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.varifyT_global</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="tfree"><span>'b</span></span><span>›</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alpha_to_beta_to_alpha_to_beta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alpha_to_beta</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>alpha_to_beta</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>alpha_to_beta_to_alpha_to_beta</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>alpha_to_beta</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="comment1"><span>(* Old Skolems throw a "TYPE" exception here, which will be caught. *)</span></span><span>
    </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ary_of</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>ary_of</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ary_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="comment1"><span>(* This function only makes sense if "T" is as general as possible. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>domain_type</span><span> </span><span>|&gt;</span><span> </span><span>dest_funT</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>old_skolem_const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>rev</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>TVar</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_poly_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>dest_funT</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Sign.const_typargs</span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="comment1"><span>(* Converts an Isabelle/HOL term (with combinators) into an intermediate term. Also accumulates sort
   infomation. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iterm_of_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t0_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t0</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t0_atomics_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1_atomics_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2_atomics_Ts</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>iot</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>Q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>P</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Q'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Q_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>Q</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Q'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P_atomics_Ts</span></span><span> </span><span class="entity"><span>Q_atomics_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_fixed_var</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>Meson_Clausify.new_skolem_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>strip_type</span><span> </span><span>|&gt;</span><span> </span><span>swap</span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_skolem_const_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>make_schematic_var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>nth</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vary</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>vary</span></span><span> </span><span>o</span><span> </span><span>Symbol.bump_string</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vary</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_bound_var</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>iot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* "_query" and "_at" are for the ASCII-challenged Metis and Mirabelle. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>queries</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"?"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"_query"</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"@"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"_at"</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_unsuffixes</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>some</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_enc_of_string</span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"tc_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"poly_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>With_Phantom_Type_Vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"ml_poly_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>Without_Phantom_Type_Vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"raw_mono_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Raw_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"mono_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_unsuffixes</span></span><span> </span><span class="entity"><span>queries</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_unsuffixes</span></span><span> </span><span class="entity"><span>queries</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strictness</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strictness</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Uniform</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>try_unsuffixes</span></span><span> </span><span class="entity"><span>ats</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Undercover_Types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>All_Types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>native_of_string</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_arith"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>with_ite </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> with_let </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>core</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="inner_quoted"><span>"_fool"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Without_FOOL</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>core</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"native"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First_Order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First_Order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"native_higher"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="entity"><span>THF_With_Choice</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="entity"><span>THF_With_Choice</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nonnative_of_string</span></span><span> </span><span class="entity"><span>core</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>core</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"guards"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
           </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tags"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
           </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"args"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span> </span><span class="comment1"><span>(* naja *)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="entity"><span>Without_Ctr_Optim</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"args"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Uniform</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* naja *)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="entity"><span>With_Ctr_Optim</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"erased"</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_Types</span></span><span> </span><span class="comment1"><span>(* naja *)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>With_Phantom_Type_Vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>No_Types</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Same.SAME</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"native"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>native_of_string</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>nonnative_of_string</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Same.SAME</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown type encoding: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min_hologic</span></span><span> </span><span class="entity"><span>THF_Lambda_Free</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>THF_Lambda_Free</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_hologic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>THF_Lambda_Free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>THF_Lambda_Free</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_hologic</span></span><span> </span><span class="entity"><span>THF_Without_Choice</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>THF_Without_Choice</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_hologic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>THF_Without_Choice</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>THF_Without_Choice</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_hologic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>THF_With_Choice</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_hologic</span></span><span> </span><span class="entity"><span>hologic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="entity"><span>hologic'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Higher_Order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min_hologic</span></span><span> </span><span class="entity"><span>hologic</span></span><span> </span><span class="entity"><span>hologic'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_hologic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_syntax</span></span><span> </span><span class="main"><span>{</span></span><span>with_ite </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ite1</span></span><span class="main"><span>,</span></span><span> with_let </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>let1</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>{</span></span><span>with_ite </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ite2</span></span><span class="main"><span>,</span></span><span> with_let </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>let2</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>with_ite </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ite1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ite2</span></span><span class="main"><span>,</span></span><span> with_let </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>let1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>let2</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>adjust_syntax</span></span><span> </span><span class="entity"><span>syntax</span></span><span> </span><span class="entity"><span>syntax'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_fool</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Without_FOOL</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_type_classes</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>With_Phantom_Type_Vars</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>no_type_classes</span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>THF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hologic</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>adjust_hologic</span></span><span> </span><span class="entity"><span>hologic</span></span><span> </span><span class="entity"><span>order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>adjust_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fool</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Polymorphic</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>no_type_classes</span></span><span> </span><span class="entity"><span>poly'</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Monomorphic</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TFF</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fool</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fool'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First_Order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>adjust_fool</span></span><span> </span><span class="entity"><span>fool</span></span><span> </span><span class="entity"><span>fool'</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Polymorphic</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>no_type_classes</span></span><span> </span><span class="entity"><span>poly'</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Monomorphic</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DFG</span></span><span> </span><span class="entity"><span>Polymorphic</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First_Order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Without_FOOL</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DFG</span></span><span> </span><span class="entity"><span>Monomorphic</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First_Order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Without_FOOL</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_type_classes</span></span><span> </span><span class="entity"><span>poly</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="entity"><span>CNF_UEQ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Guards</span></span><span> </span><span class="entity"><span>stuff</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_sound</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Tags</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Guards</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stuff</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simple_translate_lambdas</span></span><span> </span><span class="entity"><span>eta_matters</span></span><span> </span><span class="entity"><span>do_lambdas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>eta_matters</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_first_order_lambda_free</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span>›</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_first_order</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Envir.eta_contract</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_lambdas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t3</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Envir.eta_contract</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_lambdas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.import_terms</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>t'</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>trans_fool</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>trans_first_order</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
         </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t1</span></span><span>
    </span><span>$</span><span> </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lam_lifted_poly_prefix</span></span><span> </span><span>^</span><span> </span><span>serial_string</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span>fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>concealed_bound_name</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_weak_prefix</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conceal_bounds</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="entity"><span>concealed_bound_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reveal_bounds</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>subst_atomic</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concealed_bound_name</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_introduce_combinators</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>conceal_bounds</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
     </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
     </span><span>|&gt;</span><span> </span><span class="entity"><span>Meson_Clausify.introduce_combinators_in_cterm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
     </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_equals</span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
     </span><span>|&gt;</span><span> </span><span class="entity"><span>reveal_bounds</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* A type variable of sort "{}" will make abstraction fail. *)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_cheaply_conceal_lambdas</span></span><span> </span><span class="entity"><span>Ts</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>introduce_combinators</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simple_translate_lambdas</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>do_introduce_combinators</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>lam_lifted_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Const</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constify_lifted</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_binder</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_binder</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lambda_Lifting.is_quantifier</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_lams_part_1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="entity"><span>hol_close_form</span></span><span> </span><span>#&gt;</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>#-&gt;</span><span> </span><span class="entity"><span>Lambda_Lifting.lift_lambdas</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lam_lifted_poly_prefix</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lam_lifted_mono_prefix</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_a"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>is_binder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>fst</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_lams_part_2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* Lambda-lifting sometimes leaves some lambdas around; we need some way to get rid of them *)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>introduce_combinators</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>constify_lifted</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* Requires bound variables not to clash with any schematic variables (as should be the case right
     after lambda-lifting). *)</span></span><span>
  </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_open_form</span></span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="entity"><span>hol_close_form_prefix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>||&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_open_form</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_lams</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>?</span><span>
   </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simple_translate_lambdas</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>lift_lams_part_1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>lift_lams_part_2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lam</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>||&gt;</span><span> </span><span>rev</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>head</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head_T</span></span><span> </span><span>|&gt;</span><span> </span><span>binder_types</span><span> </span><span>|&gt;</span><span> </span><span>take</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>|&gt;</span><span> </span><span>rev</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>|&gt;</span><span> </span><span>subst_atomic</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>swap</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>Bound</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>head_T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>head</span></span><span> </span><span>$</span><span> </span><span>fold</span><span> </span><span class="entity"><span>lam</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ifact</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
   stature </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>,</span></span><span>
   role </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>atp_formula_role</span></span><span class="main"><span>,</span></span><span>
   iformula </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iterm</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_formula</span></span><span class="main"><span>,</span></span><span>
   atomic_types </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_iformula</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> stature </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>,</span></span><span> role </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> iformula </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> atomic_types </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>}</span></span><span>
  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ifact_lift</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>iformula</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>get_T</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_T</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_instance</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>get_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_generalization</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>get_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dom_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ran_T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ran_T</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>cons</span><span> </span><span class="entity"><span>dom_T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_tag_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="comment1"><span>(* FIXME: why not "type_guard_name" as well? *)</span></span><span>
      </span><span class="entity"><span>T_args</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_type_args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_type_args</span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>strip_ty</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binder_Us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_ty</span></span><span> </span><span class="entity"><span>U</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_U_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>binder_Us</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_U_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>body_U</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="entity"><span>U_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_U_vars</span></span><span> </span><span class="entity"><span>U_var</span></span><span class="main"><span>,</span></span><span>
                           </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_U_vars</span></span><span> </span><span class="entity"><span>U_var</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="entity"><span>T</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span>dummyT</span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>U_arg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="main"><span>(</span></span><span>dest_TVar</span><span> </span><span class="entity"><span>U_arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>U_args</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_always_ctr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>type_equiv</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>noninfer_type_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_type_args</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_infer_type_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_type_args</span></span><span> </span><span>fst</span><span> </span><span>strip_type</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No_Types</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>poly</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mangled_Monomorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>T_args</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>All_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>noninfer_type_args</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>noninfer_type_args</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Const_Types</span></span><span> </span><span class="entity"><span>Without_Ctr_Optim</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="entity"><span>is_always_ctr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>ctr_infer_type_args</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>T_args</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>AType</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_fun_type</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_bool_type</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>`</span><span class="entity"><span>make_fixed_type_const</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_tfree</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_term_of_atp_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>atp_term_of_atp_type</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>atp_term_of_atp_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_type_of_type_arg</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dummyT</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* This shouldn't clash with anything else. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncurried_alias_sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\000"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mangled_type_sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"\001"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ascii_of_uncurried_alias_sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>uncurried_alias_sep</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangled_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>raw_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_native_type</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_bool_type</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_fun_type</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_individual_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>native_type_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>native_atp_type_of_raw_atp_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_mangled_atype</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>make_native_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>generic_mangled_type_name</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_poly_atype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>to_poly_atype</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_poly_atype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_atype</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_poly_atype</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>to_mangled_atype</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_afun</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_ho</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_fun_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_afun</span></span><span> </span><span class="entity"><span>to_ho</span></span><span> </span><span class="entity"><span>to_ho</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>to_atype</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_ho</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_lfho</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_fun_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_afun</span></span><span> </span><span class="entity"><span>to_ho</span></span><span> </span><span class="entity"><span>to_lfho</span></span><span> </span><span class="entity"><span>tys</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bool_atype</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>to_atype</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_lfho</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_fo</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bool_atype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>to_atype</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_fo</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_afun</span></span><span> </span><span class="entity"><span>to_atype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_fo</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_fo</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_ho</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_lfho</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>to_fo</span></span><span> </span><span class="entity"><span>ary</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>native_atp_type_of_raw_atp_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>raw_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

</span><span class="comment1"><span>(* Make atoms for sorted type variables. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generic_add_sorts_on_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>generic_add_sorts_on_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>generic_add_sorts_on_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ss</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_sorts_on_tfree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generic_add_sorts_on_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>S</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_sorts_on_tfree</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_sorts_on_tvar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generic_add_sorts_on_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>S</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_sorts_on_tvar</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_type_args</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_native</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>atp_term_of_atp_type</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>atp_type_of_type_arg</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>cl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_type_args</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm_args</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>tm_args</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>Without_Phantom_Type_Vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>TYPE_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_atoms</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>class_membs_of_types</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>add_sorts_on_typ</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>No_Types</span></span><span> </span><span>?</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_sorts_on_typ</span></span><span> </span><span class="entity"><span>Ts</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_aconns</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span>#&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_aconn</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ahorn</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_ahorn</span></span><span> </span><span class="entity"><span>phis</span></span><span> </span><span class="entity"><span>psi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AImplies</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_aconns</span></span><span> </span><span class="entity"><span>AAnd</span></span><span> </span><span class="entity"><span>phis</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>psi</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>q'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_atyquant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_atyquant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>q'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_atyquant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_universally</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phis</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_formula_vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_variable</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>tvar_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span>I</span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_formula_universally</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>close_universally</span></span><span> </span><span class="entity"><span>add_term_vars</span></span><span> </span><span class="entity"><span>phi</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>tm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aliased_uncurried</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of_uncurried_alias_sep</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unaliased_uncurried</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>space_explode</span><span> </span><span class="entity"><span>uncurried_alias_sep</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span>unsuffix</span><span> </span><span class="entity"><span>s2</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"ill-formed explicit application alias"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_mangled_const_name</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_suffix</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span>o</span><span> </span><span class="entity"><span>g</span></span><span> </span><span>o</span><span> </span><span>prefix</span><span> </span><span class="entity"><span>mangled_type_sep</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>type_suffix</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ascii_of</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>type_suffix</span></span><span> </span><span>snd</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangled_const_name</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atp_type_of_type_arg</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>raw_mangled_const_name</span></span><span> </span><span class="entity"><span>generic_mangled_type_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_mangled_ident</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.many1</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>","</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>implode</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_mangled_type</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mangled_ident</span></span><span>
   </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>parse_mangled_types</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>--|</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_mangled_types</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mangled_type</span></span><span> </span><span>:::</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_mangled_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unmangled_type</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>suffix</span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span>|&gt;</span><span> </span><span>raw_explode</span><span>
    </span><span>|&gt;</span><span> </span><span>Scan.finite</span><span> </span><span>Symbol.stopper</span><span>
           </span><span class="main"><span>(</span></span><span>Scan.error</span><span> </span><span class="main"><span>(</span></span><span>!!</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized mangled type "</span></span><span> </span><span>^</span><span>
                                                </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parse_mangled_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fst</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unmangled_const_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unaliased_uncurried</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span>space_explode</span><span> </span><span class="entity"><span>mangled_type_sep</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unmangled_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unmangled_const_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>unmangled_type</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>invert_const</span></span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span class="entity"><span>unmangled_const_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_unique_name</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>generate_unique_name</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>unique</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eta_expand_quantifier_body</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eta_expand_quantifier_body</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="comment1"><span>(* We accumulate all variables because E 2.5 does not support variable shadowing. *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars_of_iterm</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_unique_name</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"X"</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>bound_var_prefix</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_builtins_and_proxies_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_fool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_ite</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_type_enc_ite</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_let</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_type_enc_let</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_choice</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_type_enc_choice</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>ho_quant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="comment1"><span>(* Eta-expand "!!" and "??", to work around LEO-II, Leo-III, and Satallax parser
           limitations. This works in conjunction with special code in "ATP_Problem" that uses the
           syntactic sugar "!" and "?" whenever possible. *)</span></span><span>
        </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>ho_quant</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                          </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>ho_quant</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>ho_quant</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tweak_ho_equal</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="comment1"><span>(* Eta-expand partially applied THF equality, because the LEO-II and Satallax parsers
           complain about not being able to infer the type of "=". *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"Y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"Z"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                  </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"Y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                            </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="inner_quoted"><span>"Z"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>tm2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm2''</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm1'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_let</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm2'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>let_bound_var_prefix</span></span><span> </span><span>o</span><span> </span><span>unprefix</span><span> </span><span class="entity"><span>bound_var_prefix</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>name</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alpha_rename</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Function abstraction expected"</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>tm2'</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_ho_forall</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_ho_exists</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_choice</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>eta_expand_quantifier_body</span></span><span> </span><span class="entity"><span>tm2'</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>tm2'</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tm2'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2''</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_ite</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c_If"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_ite</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_let</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"c_Let"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_let</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proxify_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>proxy_base</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>plain_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proxy_base</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>prefix</span><span> </span><span class="entity"><span>const_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>handle_min_card</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>argc</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="inner_quoted"><span>"c_False"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_false</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_True"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_true</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>plain_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="inner_quoted"><span>"c_False"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_false</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_True"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_true</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Not"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_conj"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_disj"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_or</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_implies"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_All"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>tptp_ho_forall</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>args</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Ex"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>tptp_ho_exists</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>args</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Choice"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_choice</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="entity"><span>handle_min_card</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_choice</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="entity"><span>tweak_ho_equal</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>argc</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>plain_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fool</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="inner_quoted"><span>"c_False"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_false</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_True"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_true</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Not"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_conj"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_disj"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_or</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_implies"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_All"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>tptp_ho_forall</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Ex"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>tptp_ho_exists</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"c_Choice"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="entity"><span>handle_fool</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>plain_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="entity"><span>proxy_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_choice</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                 </span><span class="entity"><span>tweak_ho_quant</span></span><span> </span><span class="entity"><span>tptp_choice</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>args</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                 </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>intro</span></span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangle_type_args_in_const</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_type_enc_mangling</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>mangled_const_name</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangle_type_args_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_mangling</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mangle</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mangle_type_args_in_const</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mangle</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_type_args_in_const</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_type_args_in_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No_Types</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_choice</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>T_args</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unmangled_invert_const</span></span><span> </span><span class="entity"><span>s''</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_type_args_in_iterm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>filter_type_args_in_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>filt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iformula_of_prop</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>iterm_of_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.eta_contract</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>introduce_builtins_and_proxies_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
           </span><span>#&gt;</span><span> </span><span class="entity"><span>mangle_type_args_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>AAtom</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_quant</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AExists</span></span><span> </span><span>?</span><span> </span><span>not</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_all_bound_var</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_exist_bound_var</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_bound_var</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t'</span></span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span>##&gt;</span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_conn</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>pos1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>pos2</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos1</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos2</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_aconn</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>not</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>mk_anot</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_quant</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_quant</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AExists</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.conj|const"><span>conj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_conn</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AAnd</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>disj</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_conn</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AOr</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_conn</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AImplies</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>not</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>t2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>do_conn</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>AIff</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>presimplify_term</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_Const</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Meson.presimplified_consts</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Skip_Proof.make_thm</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Meson.presimplify</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.prop_of</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess_abstractions_in_terms</span></span><span> </span><span class="entity"><span>trans_lams</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lambda_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>trans_lams</span></span><span>
            </span><span>|&gt;&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lambda_ts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lam_fact_prefix</span></span><span> </span><span>^</span><span> </span><span>Int.toString</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Global</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Metis's use of "resolve_tac" freezes the schematic variables. We simulate this in Sledgehammer to
   prevent the discovery of unreplayable proofs. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* Freshness is desirable for completeness, but not for soundness. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>indexed_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>atp_weak_suffix</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indexed_name</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>freeze</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_tvar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indexed_name</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>exists_subterm</span><span> </span><span>is_Var</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>freeze</span></span><span>
      </span><span>|&gt;</span><span> </span><span>exists_type</span><span> </span><span class="main"><span>(</span></span><span>exists_subtype</span><span> </span><span>is_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
         </span><span>?</span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>map_type_tvar</span><span> </span><span class="entity"><span>freeze_tvar</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>presimp_prop</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>Envir.beta_eta_contract</span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>transform_elim_prop</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Object_Logic.atomize_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>need_trueprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_ho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>need_trueprop</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_ho</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>unextensionalize_def</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>cong_extensionalize_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>abs_extensionalize_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>presimplify_term</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>

</span><span class="comment1"><span>(* Satallax prefers "=" to "&lt;=&gt;" (for definitions) and Metis (CNF) requires "=" for technical
   reasons. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_use_iff_for_eq</span></span><span> </span><span class="entity"><span>CNF</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_use_iff_for_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>THF</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>format</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_use_iff_for_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_formula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>should_use_iff_for_eq</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>iformula_of_prop</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Conjecture</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>close_universally</span></span><span> </span><span class="entity"><span>add_iterm_vars</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> stature </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>,</span></span><span> role </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> iformula </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> atomic_types </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>make_formula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>iff_for_eq</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>Axiom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>formula</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>iformula </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tptp_true</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>formula</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_conjecture</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Conjecture</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>make_formula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Finite and infinite type inference **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tvar_footprint</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tvars_of</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.add_tvarsT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>tvars_of</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_arg_cover</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>footprint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_footprint</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tvar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>tvar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tvars</span></span><span class="main"><span>)</span></span><span>
             </span><span>?</span><span> </span><span>cons</span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span>null</span><span> </span><span class="entity"><span>footprint</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>footprint</span></span><span>
        </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>list_ord</span><span> </span><span>Term_Ord.indexname_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>monotonicity_info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>maybe_finite_Ts </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   surely_infinite_Ts </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   maybe_nonmono_Ts </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(* These types witness that the type classes they belong to allow infinite
   models and hence that any types with these type classes is monotonic. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_infinite_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.intT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.realT</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_type_kind_of_surely_infinite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="entity"><span>cached_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>strictness</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Strict</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_type_surely_infinite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>cached_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span>

</span><span class="comment1"><span>(* Finite types such as "unit", "bool", "bool * bool", and "bool =&gt; bool" are
   dangerous because their "exhaust" properties can easily lead to unsound ATP
   proofs. On the other hand, all HOL infinite types can be given the same
   models in first-order logic (via Loewenheim-Skolem). *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>maybe_finite_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_nonmono_Ts</span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strictness</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_intersect</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maybe_nonmono_Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
       </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_instance</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_equiv</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maybe_finite_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
             </span><span class="entity"><span>is_type_kind_of_surely_infinite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>strictness</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>All_Types</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_guard_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>should_guard_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>should_guard_var</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_guard_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_maybe_universal_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>String.isPrefix</span><span> </span><span class="entity"><span>bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span>String.isPrefix</span><span> </span><span class="entity"><span>all_bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_maybe_universal_name</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>site</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Top_Level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bool option </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Eq_Arg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> bool option </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Arg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * int * int </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Elsewhere</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_tag_with_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Top_Level</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>site</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>site</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Eq_Arg</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>tag_neg_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>site</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Eq_Arg</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>SOME</span><span> </span><span>false</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_arg_cover</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_tag_with_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="comment1"><span>(** predicators and application operators **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>sym_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pred_sym </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span> min_ary </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> max_ary </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> types </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> in_conj </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_sym_tab_entries</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sym_info</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>pred_sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> min_ary </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> max_ary </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> types </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> in_conj </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_sym_info</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_predicate</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_sym_info</span></span><span> </span><span class="entity"><span>is_predicate</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>tptp_builtins</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>
      </span><span>?</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prefixed_predicator_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_sym_info</span></span><span> </span><span>true</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Min_App_Op</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Sufficient_App_Op</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Sufficient_App_Op_And_Predicator</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Full_App_Op_And_Predicator</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_syms_to_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consider_var_ary</span></span><span> </span><span class="entity"><span>const_T</span></span><span> </span><span class="entity"><span>var_T</span></span><span> </span><span class="entity"><span>max_ary</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_ary</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>type_instance</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>var_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>type_instance</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>var_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
             </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>ary</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>iter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>range_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>const_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_universal_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bool_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sufficient_App_Op</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sufficient_App_Op_And_Predicator</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bool_vars'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>bool_vars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sufficient_App_Op_And_Predicator</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_min_ary</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>{</span></span><span>pred_sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>bool_vars'</span></span><span class="main"><span>,</span></span><span>
             min_ary </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>consider_var_ary</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span>
             max_ary </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>,</span></span><span> types </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> in_conj </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>}</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_var_Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span> </span><span>|&gt;</span><span> </span><span>can</span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bool_vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bool_vars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>fun_var_Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>accum</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bool_vars'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_var_Ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>repair_min_ary</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>accum</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bool_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_maybe_universal_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>let_bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>add_universal_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>exist_bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>accum</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>bool_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                 </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>bool_vars</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>types'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>conj_fact</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="main"><span>=</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sufficient_App_Op</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                         </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sufficient_App_Op_And_Predicator</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>types'</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                       </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consider_var_ary</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span> </span><span class="entity"><span>min_ary</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                       </span><span class="entity"><span>min_ary</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                   </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>pred_sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> min_ary </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     max_ary </span><span class="main"><span>=</span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> types </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>types'</span></span><span class="main"><span>,</span></span><span> in_conj </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_ary</span></span><span> </span><span class="main"><span>=</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="entity"><span>uncurried_alias_sep</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                          </span><span class="entity"><span>ary</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                            </span><span>SOME</span><span> </span><span class="entity"><span>ary0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>top_level</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>max_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>bool_vars</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="main"><span>=</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span class="entity"><span>Min_App_Op</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>max_ary</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Full_App_Op_And_Predicator</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>consider_var_ary</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_var_Ts</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                   </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>pred_sym </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> min_ary </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> max_ary </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>,</span></span><span>
                     types </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> in_conj </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_universal_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_universal_var</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>tm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_table_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_iterm_syms_to_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span> </span><span>true</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fact_syms</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ifact_lift</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>formula_fold</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>conj_fact</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_fact_syms</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conjs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_fact_syms</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span>||&gt;</span><span> </span><span>fold</span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_sym_tab_entries</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min_ary_of</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>min_ary</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>predicator_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_guard_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* True if the constant ever appears outside of the top-level position in
   literals, or if it appears with different arities (e.g., because of different
   type instantiations). If false, the constant always receives all of its
   arguments and is used as a predicate. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_pred_sym</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_ary</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fTrue_iconst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>const_prefix</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"fTrue"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue|const"><span>fTrue</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predicator_iconst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>predicator_name</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>predicatify</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fTrue_iconst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predicator_iconst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_op</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_app</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>head</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_app_op</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>head</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_funT</span><span> </span><span class="entity"><span>head_T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_op</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>head_T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>head_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mangle_type_args_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>list_app</span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>firstorderize_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_app</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_app_op</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>arg</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_app_ops</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_app</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>head</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_app_ops</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span>||&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>introduce_app_ops</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary_of</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span>
                  </span><span class="comment1"><span>(* In polymorphic native type encodings, it is impossible to
                     declare a fully polymorphic symbol that takes more
                     arguments than its signature (even though such concrete
                     instances, where a type variable is instantiated by a
                     function type, are possible.) *)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>official_ary</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                        </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invert_const</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                          </span><span>SOME</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ary</span></span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="inner_numeral"><span>1000000000</span></span><span> </span><span class="comment1"><span>(* irrealistically big arity *)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>official_ary</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>min_ary</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aliased_uncurried</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>list_app</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>list_app_ops</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>list_app_ops</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>introduce_app_ops</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>list_app_ops</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_predicators</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_pred_sym</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>predicatify</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>predicatify</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_ho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_full_ho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_fool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_iterm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>is_ho</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>introduce_app_ops</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_full_ho</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_fool</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>introduce_predicators</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>filter_type_args_in_iterm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>update_iformula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>formula_map</span></span><span> </span><span class="entity"><span>do_iterm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Helper facts **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_ffalse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fFalse|const"><span>fFalse</span></a><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fFalse_def|fact"><span>fFalse_def</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.fast|method"><span class="operator"><span>fast</span></span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ftrue</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue|const"><span>fTrue</span></a><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue_def|fact"><span>fTrue_def</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.fast|method"><span class="operator"><span>fast</span></span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="comment1"><span>(* The Boolean indicates that a fairly sound type encoding is needed. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>helper_table</span></span><span> </span><span class="entity"><span>with_combs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>with_combs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"COMBI"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBI_def|fact"><span>Meson.COMBI_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"COMBK"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBK_def|fact"><span>Meson.COMBK_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"COMBB"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBB_def|fact"><span>Meson.COMBB_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"COMBC"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBC_def|fact"><span>Meson.COMBC_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"COMBS"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.COMBS_def|fact"><span>Meson.COMBS_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>predicator_name</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_ffalse</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ftrue</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fFalse"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_ffalse</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fFalse"</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.True_or_False|fact"><span>True_or_False</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fTrue"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ftrue</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fTrue"</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.True_or_False|fact"><span>True_or_False</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"If"</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_True|fact"><span>if_True</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_False|fact"><span>if_False</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.True_or_False|fact"><span>True_or_False</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fNot"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fNot_def|fact"><span>fNot_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.iff_to_disjD|fact"><span>Meson.iff_to_disjD</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.conjunct1|fact"><span>conjunct1</span></a><span class="main"><span>]</span></span><span>
           </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fNot_def|fact"><span>fNot_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.iff_to_disjD|fact"><span>Meson.iff_to_disjD</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.conjunct2|fact"><span>conjunct2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fconj"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj|const"><span>fconj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj|const"><span>fconj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj|const"><span>fconj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_def|fact"><span>fconj_def</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.fast|method"><span class="operator"><span>fast</span></span></a><span class="main"><span class="keyword3"><span>+</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fdisj"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj|const"><span>fdisj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj|const"><span>fdisj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj|const"><span>fdisj</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_def|fact"><span>fdisj_def</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.fast|method"><span class="operator"><span>fast</span></span></a><span class="main"><span class="keyword3"><span>+</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fimplies"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies|const"><span>fimplies</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies|const"><span>fimplies</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies|const"><span>fimplies</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span><span>
        </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies_def|fact"><span>fimplies_def</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.fast|method"><span class="operator"><span>fast</span></span></a><span class="main"><span class="keyword3"><span>+</span></span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fequal"</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="comment1"><span>(* This is a lie: Higher-order equality doesn't need a sound type encoding.
       However, this is done so for backward compatibility: Including the
       equality helpers by default in Metis breaks a few existing proofs. *)</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal_def|fact"><span>fequal_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.iff_to_disjD|fact"><span>Meson.iff_to_disjD</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.conjunct1|fact"><span>conjunct1</span></a><span class="main"><span>]</span></span><span>
           </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal_def|fact"><span>fequal_def</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../Meson.html#Meson.iff_to_disjD|fact"><span>Meson.iff_to_disjD</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.conjunct2|fact"><span>conjunct2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="comment1"><span>(* Partial characterization of "fAll" and "fEx". A complete characterization
      would require the axiom of choice for replay with Metis. *)</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fAll"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll|const"><span>fAll</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span>:</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll_def|fact"><span>fAll_def</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fEx"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx|const"><span>fEx</span></a><span> </span><span class="free"><span>P</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span>:</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx_def|fact"><span>fEx_def</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fChoice"</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fChoice_iff_Ex|fact"><span>fChoice_iff_Ex</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>zero_var_indexes</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_skolemizable</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_skolemizable</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_no_skolemizable_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.exists_subterm</span><span> </span><span class="entity"><span>is_skolemizable</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.full_prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>error</span><span> </span><span class="inner_quoted"><span>"Theorems of the helper table cannot contain skolemizable terms because they don't \
        \get skolimized in metis."</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>helper_table</span></span><span> </span><span>true</span><span>
    </span><span>|&gt;</span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_no_skolemizable_thm</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>completish_helper_table</span></span><span> </span><span class="entity"><span>with_combs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>helper_table</span></span><span> </span><span class="entity"><span>with_combs</span></span><span> </span><span>@</span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>predicator_name</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.True_or_False|fact"><span>True_or_False</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fTrue_ne_fFalse|fact"><span>fTrue_ne_fFalse</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>app_op_name</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>∃</span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>.</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>g</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>g</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><a class="entity_ref" href="../../../Provers/blast.ML.html#HOL.blast|method"><span class="operator"><span>blast</span></span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>General</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>∃</span></a></span><span class="bound"><span>p</span></span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>.</span></a></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>p</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><span class="bound"><span>p</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>y</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><a class="entity_ref" href="../../../Provers/blast.ML.html#HOL.blast|method"><span class="operator"><span>blast</span></span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fconj"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_table|fact"><span>fconj_table</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_laws|fact"><span>fconj_laws</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_laws|fact"><span>fdisj_laws</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fdisj"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_table|fact"><span>fdisj_table</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_laws|fact"><span>fconj_laws</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_laws|fact"><span>fdisj_laws</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fimplies"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies_table|fact"><span>fimplies_table</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fconj_laws|fact"><span>fconj_laws</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fdisj_laws|fact"><span>fdisj_laws</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fimplies_laws|fact"><span>fimplies_laws</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fequal"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal_table|fact"><span>fequal_table</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal_laws|fact"><span>fequal_laws</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fAll"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll_table|fact"><span>fAll_table</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fComp_law|fact"><span>fComp_law</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll_law|fact"><span>fAll_law</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx_law|fact"><span>fEx_law</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fEx"</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx_table|fact"><span>fEx_table</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fComp_law|fact"><span>fComp_law</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fAll_law|fact"><span>fAll_law</span></a><span> </span><a class="entity_ref" href="../../../../../ATP.html#ATP.fEx_law|fact"><span>fEx_law</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>zero_var_indexes</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sorts</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span>is_TVar</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sorts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span class="main"><span>)</span></span><span>
     </span><span>?</span><span> </span><span class="entity"><span>mk_ahorn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span>
       </span><span>|&gt;</span><span> </span><span class="entity"><span>class_membs_of_types</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>add_sorts_on_tvar</span></span><span>
       </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="entity"><span>mk_atyquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_class</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_classes</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="entity"><span>mk_atyquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_formula</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>atomic_Ts</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="entity"><span>tm1</span></span><span> </span><span class="entity"><span>tm2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AIff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="entity"><span>bounds</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>close_formula_universally</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>atomic_Ts</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>helper_rank</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default_rank</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_rank</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>9</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>helper_rank</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>10</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_rank</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>min_rank</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rank_of_fact_num</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_rank</span></span><span> </span><span>+</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_rank</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>min_rank</span></span><span class="main"><span>)</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>n</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_tag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>type_tag_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_specialize_helpers</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>No_Types</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_specialize_helper</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>could_specialize_helpers</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.hidden_polymorphism</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_helper_facts_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unmangled_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_const_name</span></span><span> </span><span>|&gt;</span><span> </span><span>hd</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dub</span></span><span> </span><span class="entity"><span>needs_sound</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>unmangled_s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unmangled_s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>mangled_s</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>needs_sound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>typed_helper_suffix</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>untyped_helper_suffix</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>specialize_helper</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unmangled_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alpha_to_beta</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Envir.subst_term_types</span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>specialize_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invert_const</span></span><span> </span><span class="entity"><span>unmangled_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dub_and_inst</span></span><span> </span><span class="entity"><span>needs_sound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>status</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>should_specialize_helper</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>specialize_helper</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>types</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>tag_list</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>dub</span></span><span> </span><span class="entity"><span>needs_sound</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Global</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>status</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_facts</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sound</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_type_enc_sound</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>could_specialize</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>could_specialize_helpers</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>with_combs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>opaque_combsN</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>helper_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>needs_sound</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_syntax</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>polymorphism</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>order</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>With_FOOL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>syntax</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>polymorphism</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_level</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_syntax</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remove_ite_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_syntax</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>with_let</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>with_ite </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> with_let </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_let</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>needs_sound</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>sound</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>helper_s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>unmangled_s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>completish</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>could_specialize</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>I</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>ths</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dub_and_inst</span></span><span> </span><span class="entity"><span>needs_sound</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>make_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>helper_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"If"</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>remove_ite_syntax</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span>iformula</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>completish_helper_table</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>helper_table</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>with_combs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>helper_facts_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_helper_facts_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>completish</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(***************************************************************)</span></span><span>
</span><span class="comment1"><span>(* Type Classes Present in the Axiom or Conjecture Clauses     *)</span></span><span>
</span><span class="comment1"><span>(***************************************************************)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_classes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldl</span><span> </span><span class="entity"><span>set_insert</span></span><span> </span><span class="entity"><span>cset</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>classes_of_terms</span></span><span> </span><span class="entity"><span>get_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_Ts</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>List.foldl</span><span> </span><span class="entity"><span>add_classes</span></span><span> </span><span>Symtab.empty</span><span> </span><span>#&gt;</span><span> </span><span>Symtab.delete_safe</span><span> </span><span class="entity"><span>class_of_types</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Symtab.keys</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfree_classes_of_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>classes_of_terms</span></span><span> </span><span class="entity"><span>Misc_Legacy.term_tfrees</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_classes_of_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>classes_of_terms</span></span><span> </span><span class="entity"><span>Misc_Legacy.term_tvars</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_type_ctrs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_type_ctrs</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_type_ctrs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="comment1"><span>(* Type constructors used to instantiate overloaded constants are the only ones
   needed. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type_ctrs_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Meson.html#Meson.skolem|const"><span>Meson.skolem</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>x</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_type_ctrs</span></span><span> </span><span class="entity"><span>set_insert</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_ctrs_of_terms</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.keys</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_type_ctrs_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans_lams_of_string</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_lamsN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opaque_liftingN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>lift_lams</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>##&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>liftingN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>lift_lams</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opaque_combsN</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>combsN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>introduce_combinators</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>combs_and_liftingN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>lift_lams_part_1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span>##&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>introduce_combinators</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>lift_lams_part_2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>combs_or_liftingN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>lift_lams_part_1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span>##&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span>strip_qnt_body</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                       </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>(=)</span></a></span><span> </span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>introduce_combinators</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intentionalize_def</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>lift_lams_part_2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>keep_lamsN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.eta_contract</span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown lambda translation scheme: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>lam_trans</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pull_and_reorder_definitions</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>consts_of_hs</span></span><span> </span><span class="entity"><span>l_or_r</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>iformula</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l_or_r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(* Quadratic, but usually OK. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>skipped</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>skipped</span></span><span> </span><span class="comment1"><span>(* break cycle *)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="entity"><span>skipped</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts_of_hs</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs_consts</span></span><span class="main"><span>)</span></span><span>
                     </span><span>o</span><span> </span><span class="entity"><span>consts_of_hs</span></span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>skipped</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>skipped</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>fact</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>skipped</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Definition</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>role</span><span class="main"><span>)</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>reorder</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>#&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_not_prop</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not_prop</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not_prop</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span></span><span>›</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_formulas</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prem_role</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>presimp</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span>
      </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trans_lams</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans_lams_of_string</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>
    </span><span class="comment1"><span>(* Remove existing facts from the conjecture, as this can dramatically boost an ATP's
       performance (for some reason). *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact_ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>freeze_term</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>freeze_term</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maybe_presimp_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>presimp</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>presimp_prop</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Axiom</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>maybe_presimp_prop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>prem_role</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Conjecture</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not_prop</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_prod</span></span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Local</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>string_of_int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>maybe_presimp_prop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_lamsN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
            </span><span>#&gt;</span><span> </span><span class="entity"><span>preprocess_abstractions_in_terms</span></span><span> </span><span class="entity"><span>trans_lams</span></span><span>
            </span><span>#&gt;&gt;</span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>conjs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>conjs</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>make_conjecture</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>pull_and_reorder_definitions</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>pull_and_reorder_definitions</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lifted</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lam_facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_lambda_def</span></span><span> </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lam_facts</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fact_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfree_classes_of_terms</span></span><span> </span><span class="entity"><span>all_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>supers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tvar_classes_of_terms</span></span><span> </span><span class="entity"><span>all_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_ctrs_of_terms</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>all_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>supers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcon_clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>make_tcon_clauses</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tycons</span></span><span> </span><span class="entity"><span>supers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subclass_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_subclass_pairs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>supers</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>supers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>lam_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subclass_pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcon_clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>type_guard_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_guard_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>mangle_type_args_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_var_positively_naked_in_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_var_positively_naked_in_term</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_var_positively_naked_in_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_var_undercover_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_undercover</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_undercover</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>tms</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_arg_cover</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
          </span><span>exists</span><span> </span><span class="entity"><span>is_undercover</span></span><span> </span><span class="entity"><span>tms</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_undercover</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>is_undercover</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_guard_var_in_formula</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>All_Types</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>formula_fold</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_var_undercover_in_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Uniform</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Non_Uniform</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>formula_fold</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_var_positively_naked_in_term</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_guard_var_in_formula</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>always_guard_var_in_formula</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_generate_tag_bound_decl</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_generate_tag_bound_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>should_generate_tag_bound_decl</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_aterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_type_args</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm_args</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_bound_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>#&gt;</span><span> </span><span>SOME</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_tag</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>mangle_type_args_in_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>atp_term_of_iterm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pos</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected lambda-abstraction"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>atp_term_of_iterm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>site</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>site</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Top_Level</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Eq_Arg</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arg_site</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Eq_Arg</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_site</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_aterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>Elsewhere</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_aterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_type_enc_fool</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>AAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>Elsewhere</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>Elsewhere</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected lambda-abstraction"</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"impossible \"IApp\""</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>should_tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>site</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>tag</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Top_Level</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>formula_of_iformula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>should_guard_var</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_term_of_iterm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_out_of_bound_type</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>should_guard_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
             </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>should_guard_var</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>type_guard_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span>|&gt;</span><span> </span><span>SOME</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>should_generate_tag_bound_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tagged_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>var</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="entity"><span>tptp_equal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tagged_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AExists</span></span><span> </span><span>?</span><span> </span><span>not</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                                        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>do_bound_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_ahorn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_aconn</span></span><span> </span><span class="entity"><span>AAnd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>map_filter</span><span>
                           </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                               </span><span class="entity"><span>do_out_of_bound_type</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>universal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="entity"><span>conn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aconn_map</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>conn</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>General</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Induction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inductionN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>introN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Inductive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Elim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elimN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Simp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simpN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>non_rec_defN</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>Rec_Def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_defN</span></span><span>

</span><span class="comment1"><span>(* Each fact is given a unique fact number to avoid name clashes (e.g., because
   of monomorphization). The TPTP forbids name clashes, and some of the remote
   provers might care. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>encode</span></span><span> </span><span class="entity"><span>alt</span></span><span> </span><span class="entity"><span>freshen</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>rank</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> stature </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>status</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>freshen</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
            </span><span class="entity"><span>encode</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>iformula</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>formula_of_iformula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
                  </span><span class="entity"><span>should_guard_var_in_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>close_formula_universally</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>,</span></span><span>
           </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of_status</span></span><span> </span><span class="entity"><span>status</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rank</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_subclass</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sub</span></span><span> </span><span class="entity"><span>super</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>subclass_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>sub</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"___"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>super</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AImplies</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>super</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvar_a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tvar_a</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
           </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_subclass_pair</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>supers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>Class_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span> </span><span>`</span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>sub</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_class</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>supers</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lines_of_subclass</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sub</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>supers</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_tcon_clause</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>Class_Memb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_memb_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>dest_TVar</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>tvar_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_class</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>`</span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tcon_clause_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>mk_ahorn</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_atoms</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_conjecture</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>conjecture_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>iformula</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>formula_of_iformula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>should_guard_var_in_formula</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>close_formula_universally</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>atomic_types</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_free_types</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_classes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>polymorphism_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Class_Polymorphic</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>type_classes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Class_Memb</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_memb_prefix</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>`</span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tfree_clause_prefix</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>class_atom</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>membs</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>atomic_types </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>class_membs_of_types</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>add_sorts_on_tfree</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>map_index</span><span> </span><span class="entity"><span>line</span></span><span> </span><span class="entity"><span>membs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(** Symbol declarations **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_line_of_class</span></span><span> </span><span class="entity"><span>phantoms</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_class</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Sym_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>APi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>tvar_a_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>phantoms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Without_Phantom_Type_Vars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                     </span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_itself_atype</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_atype</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                     </span><span class="entity"><span>bool_atype</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_lines_of_classes</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>phantoms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decl_line_of_class</span></span><span> </span><span class="entity"><span>phantoms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_decl_table_of_facts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_iterm_comb</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decl_sym</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
              </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>let_bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
              </span><span class="entity"><span>is_tptp_user_symbol</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>decl_sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>I</span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>tm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_fact_syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ifact_lift</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>formula_fold</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="entity"><span>phis</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tvar_a</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ifact_lift</span></span><span> </span><span class="entity"><span>add_formula_var_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="comment1"><span>(* Don't add declaration for undefined_bool as bool already has fTrue and fFalse als witnesses
       and this declaration causes problems in FOF if undefined_bool occurs without predicator pp.
     *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_undefined_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_undefined_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_mangling</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>mangled_const_name</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_TYPE_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TYPE_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tvar_a</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span>itself</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Symtab.empty</span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>is_type_enc_sound</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
       </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_fact_syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>]</span></span><span>
          </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_iterm_syms</span></span><span> </span><span class="entity"><span>extra_tms</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Raw_Polymorphic</span></span><span> </span><span class="entity"><span>phantoms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>phantoms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Without_Phantom_Type_Vars</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>add_TYPE_const</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="comment1"><span>(* Add constants "undefined" as witnesses that the types are inhabited. *)</span></span><span>
                </span><span>fold</span><span> </span><span class="entity"><span>add_undefined_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* We add "bool" in case the helper "True_or_False" is included later. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>maybe_finite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
   surely_infinite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Strict</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>known_infinite_types</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   maybe_nonmono_Ts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tvar_a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(* This inference is described in section 4 of Blanchette et al., "Encoding
   monomorphic and polymorphic types", TACAS 2013. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iterm_mononotonicity_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>polarity</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>mono</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>maybe_finite_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_nonmono_Ts</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_mono</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Nonmono_Types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strictness</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_instance</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
           </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_equiv</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maybe_finite_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>mono</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_kind_of_surely_infinite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>strictness</span></span><span>
                                                </span><span class="entity"><span>surely_infinite_Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>{</span></span><span>maybe_finite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maybe_finite_Ts</span></span><span class="main"><span>,</span></span><span>
           surely_infinite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
           maybe_nonmono_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maybe_nonmono_Ts</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>{</span></span><span>maybe_finite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maybe_finite_Ts</span></span><span> </span><span>|&gt;</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_equiv</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
           surely_infinite_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>surely_infinite_Ts</span></span><span class="main"><span>,</span></span><span>
           maybe_nonmono_Ts </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maybe_nonmono_Ts</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mono</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../ATP.html#ATP.fequal|const"><span>fequal</span></a><span>›</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>update_mono</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mono</span></span><span> </span><span>|&gt;</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>polarity</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_maybe_universal_var</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
         </span><span>?</span><span> </span><span class="entity"><span>update_mono</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>update_mono_rec</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fact_mononotonicity_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iformula</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ifact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>formula_fold</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Conjecture</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iterm_mononotonicity_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iformula</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mononotonicity_info_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>default_mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>completish</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>is_type_level_monotonicity_based</span></span><span> </span><span class="entity"><span>level</span></span><span>
       </span><span>?</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_fact_mononotonicity_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_arg_types</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>fold_arg_types</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>tm1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold_term_types</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>tm2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_arg_types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>fold_term_types</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ityp_of</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>fold_arg_types</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>tm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iformula_monotonic_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>should_encode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>should_encode</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>insert_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>formula_fold</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_term_types</span></span><span> </span><span class="entity"><span>add_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fact_monotonic_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ifact_lift</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iformula_monotonic_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monotonic_types_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
           </span><span class="entity"><span>is_type_level_monotonicity_based</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span>
          </span><span>?</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_fact_monotonic_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_guards_mono_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>guards_sym_formula_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mangled_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_bound_var</span></span><span> </span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>type_guard_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>AAtom</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>formula_of_iformula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>always_guard_var_in_formula</span></span><span>
                                  </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>close_formula_universally</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_tags_mono_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>make_bound_var</span></span><span> </span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tags_sym_formula_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mangled_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>eq_formula</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>false</span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>x_var</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x_var</span></span><span class="main"><span>,</span></span><span>
             </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>non_rec_defN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_mono_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_guards_mono_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_tags_mono_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_line_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected type arguments"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Sym_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="entity"><span>ary</span></span><span>
        </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>curry</span><span> </span><span class="entity"><span>APi</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span> </span><span>o</span><span> </span><span>dest_TVar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>honor_conj_sym_role</span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Axiom</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>line_of_guards_sym_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>j</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_negate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>honor_conj_sym_role</span></span><span> </span><span class="entity"><span>in_conj</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span>o</span><span> </span><span class="entity"><span>make_bound_var</span></span><span> </span><span>o</span><span> </span><span>string_of_int</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>All_Types</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span>SOME</span><span> </span><span class="entity"><span>arg_Ts</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_arg_cover</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>arg_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_Ts</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>guards_sym_formula_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IApp</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>type_guard_iterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>res_T</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>AAtom</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_aquant</span></span><span> </span><span class="entity"><span>AForall</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>bound_Ts</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>formula_of_iformula</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
                                    </span><span class="entity"><span>always_guard_var_in_formula</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>close_formula_universally</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>maybe_negate</span></span><span class="main"><span>,</span></span><span>
             </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_tags_sym_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>level_of_type_enc</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ident</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>tags_sym_formula_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_negate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>honor_conj_sym_role</span></span><span> </span><span class="entity"><span>in_conj</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span>o</span><span> </span><span class="entity"><span>make_bound_var</span></span><span> </span><span>o</span><span> </span><span>string_of_int</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_aterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>maybe_negate</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>eq_formula</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tag_with</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tag_with_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ident</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tag_with</span></span><span> </span><span class="entity"><span>res_T</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>non_rec_defN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>res_T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Undercover_Types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_arg_cover</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ary</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_tag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cover</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>tag_with</span></span><span> </span><span class="entity"><span>arg_T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span>|&gt;</span><span> </span><span>map2</span><span> </span><span class="entity"><span>maybe_tag</span></span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cst</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cst</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>result_type_of_decl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rationalize_decls</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>result_type_of_decl</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>|&gt;</span><span> </span><span>map_type_tvar</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_generalization</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>result_type_of_decl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>decls'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>decl</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>decls</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rationalize_decls</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decls</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_sym_decls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>decls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>decl_line_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>decls</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Guards</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>rationalize_decls</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>decls</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>should_encode_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>result_type_of_decl</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_guards_sym_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>decls</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tags</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>level</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_level_uniform</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>decls</span></span><span>
        </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lines_of_tags_sym_decl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lines_of_sym_decl_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="entity"><span>sym_decl_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sym_decl_tab</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.dest</span><span> </span><span>|&gt;</span><span> </span><span>sort_by</span><span> </span><span>fst</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lines_of_mono_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decl_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lines_of_sym_decls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mono_lines</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>decl_lines</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>datatypes_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DFG</span></span><span> </span><span class="entity"><span>Polymorphic</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Native</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span>
      </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_ctr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_fixed_const</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ary_of</span></span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_aterm</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proxify_const</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>proxy_base</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proxy_base</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>prefix</span><span> </span><span class="entity"><span>const_prefix</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aliased_uncurried</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>datatype_of_ctrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctrs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>do_ctr</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>native_atp_type_of_typ</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>ctrs'</span></span><span class="main"><span>,</span></span><span>
             </span><span>forall</span><span> </span><span>is_some</span><span> </span><span class="entity"><span>ctrs'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>ctrss</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>datatype_of_ctrs</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>datatypes_of_sym_table</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_line_of_datatype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Datatype_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>datatype_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pair_append</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ys1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ys1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ys2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_uncurried_alias_lines_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
    </span><span class="entity"><span>base_s0</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_alias</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maybe_negate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>honor_conj_sym_role</span></span><span> </span><span class="entity"><span>in_conj</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>base_s0</span></span><span> </span><span>|&gt;</span><span> </span><span>`</span><span class="entity"><span>make_fixed_const</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>robust_const_type</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>base_s0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>robust_const_type_args</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_s0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>base_s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mangle_type_args_in_const</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>base_name</span></span><span> </span><span class="entity"><span>T_args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary_of</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span> </span><span class="entity"><span>base_s</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_args</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>filter_ty_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter_type_args_in_iterm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>atp_term_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atp_term_of_iterm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>base_name</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>base_ary</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>aliased_uncurried</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>base_name</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>aliased_uncurried</span></span><span> </span><span class="entity"><span>ary</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_fun</span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span>o</span><span> </span><span class="entity"><span>make_bound_var</span></span><span> </span><span>o</span><span> </span><span>string_of_int</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>arg_Ts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>first_bounds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>last_bound</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>bounds</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IConst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>split_last</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_app_op</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>name1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>first_bounds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>last_bound</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>filter_ty_args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm2</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>list_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_const</span></span><span> </span><span class="entity"><span>name2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>first_bounds</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>last_bound</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>filter_ty_args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>eq_formula</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomic_types_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_bound_type</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atp_term_of</span></span><span> </span><span class="entity"><span>tm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atp_term_of</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>tm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>[</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>uncurried_alias_eq_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>maybe_negate</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>isabelle_info</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>non_rec_defN</span></span><span> </span><span class="entity"><span>helper_rank</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>base_ary</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>pair_append</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_alias</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>do_alias</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncurried_alias_lines_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_conj</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unprefix_and_unascii</span></span><span> </span><span class="entity"><span>const_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="entity"><span>uncurried_alias_sep</span></span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_s0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mangled_s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>unmangled_invert_const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>do_uncurried_alias_lines_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span>
          </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="entity"><span>base_s0</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="entity"><span>in_conj</span></span><span> </span><span class="entity"><span>min_ary</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncurried_alias_lines_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
    </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span>
    </span><span>?</span><span> </span><span>Symtab.fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pair_append</span></span><span>
        </span><span>o</span><span> </span><span class="entity"><span>uncurried_alias_lines_of_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span>
          </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>sym_tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>implicit_declsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Could-be-implicit typings"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>explicit_declsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Explicit typings"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncurried_alias_eqsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Uncurried aliases"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>factsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Relevant facts"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subclassesN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Subclasses"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tconsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Type constructors"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>helpersN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Helper facts"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Conjectures"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_typesN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Free types"</span></span><span>

</span><span class="comment1"><span>(* TFF allows implicit declarations of types, function symbols, and predicate
   symbols (with "$i" as the type of individuals), but some provers (e.g.,
   SNARK) require explicit declarations. The situation is similar for THF. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_type</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bool_atype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>individual_atype</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>tm_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>individual_atype</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm_ary</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>ty_ary</span></span><span> </span><span class="entity"><span>tm_ary</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>APi</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>ty_ary</span></span><span> </span><span class="entity"><span>tvar_a_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>tm_ary</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>undeclared_in_problem</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_user_symbol</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>let_bound_var_prefix</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Symtab.default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_class</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>do_bound_tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_class</span></span><span> </span><span>o</span><span> </span><span>snd</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AType</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>tys</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AFun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>APi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>default_type</span></span><span> </span><span class="entity"><span>pred_sym</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_type</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>do_class</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>snd</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>phis</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_term</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>tm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Class_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_class</span></span><span> </span><span class="entity"><span>cls</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Type_Decl</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sym_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Datatype_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="entity"><span>do_bound_tvars</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>do_term</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Class_Memb</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>do_bound_tvars</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>do_class</span></span><span> </span><span class="entity"><span>cl</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>do_formula</span></span><span> </span><span class="entity"><span>phi</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declared_in_atp_problem</span></span><span> </span><span class="entity"><span>problem</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
    </span><span>||&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>tvar_a_atype</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>do_line</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declare_undeclared_in_problem</span></span><span> </span><span class="entity"><span>heading</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>syms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>undeclared_in_problem</span></span><span> </span><span class="entity"><span>problem</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="comment1"><span>(* already declared *)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Class_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>class_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="comment1"><span>(* already declared *)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Type_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ary</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="comment1"><span>(* already declared *)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sym_Decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_decl_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>heading</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>decls</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_ctrss_of_datatypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctrs</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Ctr_Sugar.ctr_sugars_of</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_op_and_predicator_threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>45</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_atp_problem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>prem_role</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span>
    </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="entity"><span>readable_names</span></span><span> </span><span class="entity"><span>presimp</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>adjust_type_enc</span></span><span> </span><span class="entity"><span>format</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Completish</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(* Forcing explicit applications is expensive for polymorphic encodings,
       because it takes only one existential variable ranging over "'a =&gt; 'b" to
       ruin everything. Hence we do it only if there are few facts (which is
       normally the case for "metis" and the minimizer). *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>completish</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Full_App_Op_And_Predicator</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_greater_equal</span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>compare_length_with</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>app_op_and_predicator_threshold</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>hyp_ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_type_enc_polymorphic</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Min_App_Op</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Sufficient_App_Op</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>Sufficient_App_Op_And_Predicator</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>keep_lamsN</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_type_enc_full_higher_order</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>liftingN</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lam_trans</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>{</span></span><span>if_simps </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_type_enc_ite</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       let_simps </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_type_enc_let</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>classes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subclass_pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcon_clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>translate_formulas</span></span><span> </span><span class="entity"><span>simp_options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prem_role</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>presimp</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span>
        </span><span class="entity"><span>concl_t</span></span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sym_table_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>app_op_level</span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mononotonicity_info_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>completish</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_ctrss_of_datatypes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>firstorderize</span></span><span> </span><span class="entity"><span>in_helper</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>firstorderize_fact</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>in_helper</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>completish</span></span><span>
        </span><span class="entity"><span>sym_tab0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>firstorderize</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ho_stuff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>sym_table_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>Min_App_Op</span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncurried_alias_eq_tms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncurried_alias_eq_lines</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>uncurried_alias_lines_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span>
        </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="entity"><span>sym_tab0</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>ho_stuff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_iterm_syms_to_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Min_App_Op</span></span><span> </span><span>false</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>uncurried_alias_eq_tms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>helpers</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>sym_tab</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>helper_facts_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>lam_trans</span></span><span> </span><span class="entity"><span>completish</span></span><span>
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>firstorderize</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>helpers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>monotonic_types_of_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>all_facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>datatypes_of_sym_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>uncurried_aliases</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>class_decl_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl_lines_of_classes</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>classes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym_decl_lines</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>conjs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>helpers</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncurried_alias_eq_tms</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>sym_decl_table_of_facts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>lines_of_sym_decl_table</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatype_decl_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>decl_line_of_datatype</span></span><span> </span><span class="entity"><span>datatypes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decl_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>class_decl_lines</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>sym_decl_lines</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>datatype_decl_lines</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>freshen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Exporter</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Translator</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Exporter</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rank_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rank_of_fact_num</span></span><span> </span><span class="entity"><span>num_facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>fact_prefix</span></span><span> </span><span class="entity"><span>ascii_of</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>freshen</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mono</span></span><span>
        </span><span class="entity"><span>type_enc</span></span><span> </span><span class="entity"><span>rank_of</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subclass_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lines_of_subclass_pair</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subclass_pairs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tcon_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_tcon_clause</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tcon_clauses</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>helper_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>helpers</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generate_isabelle_info</span></span><span> </span><span class="entity"><span>helper_prefix</span></span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span>true</span><span> </span><span class="entity"><span>mono</span></span><span>
        </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>default_rank</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_type_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lines_of_free_types</span></span><span> </span><span class="entity"><span>type_enc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>facts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>conjs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_lines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>line_of_conjecture</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>type_enc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conjs</span></span><span>
    </span><span class="comment1"><span>(* Reordering these might confuse the proof reconstruction code. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>explicit_declsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>decl_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>uncurried_alias_eqsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncurried_alias_eq_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>factsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>subclassesN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subclass_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>tconsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcon_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>helpersN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>helper_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>free_typesN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>free_type_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>conjsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conj_lines</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>problem</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="entity"><span>CNF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ensure_cnf_problem</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>CNF_UEQ</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter_cnf_ueq_problem</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>FOF</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>declare_undeclared_in_problem</span></span><span> </span><span class="entity"><span>implicit_declsN</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>problem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pool</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>nice_atp_problem</span></span><span> </span><span class="entity"><span>readable_names</span></span><span> </span><span class="entity"><span>format</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_sym_ary</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>min_ary</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>sym_info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_ary</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>?</span><span> </span><span>Symtab.insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>min_ary</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>problem</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>pool</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lifted</span></span><span class="main"><span>,</span></span><span>
     </span><span>Symtab.fold</span><span> </span><span class="entity"><span>add_sym_ary</span></span><span> </span><span class="entity"><span>sym_tab</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* FUDGE *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conj_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.0</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.1</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_min_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fact_max_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.0</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_info_default_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0.8</span></span><span>

</span><span class="comment1"><span>(* Ugly hack: may make innocent victims (collateral damage) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>may_be_app</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>app_op_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>may_be_predicator</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>predicator_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prefixed_predicator_name</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>may_be_predicator</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tm'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_predicator</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>may_be_app</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span>||&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phis</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="entity"><span>phis</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAtom</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>strip_predicator</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AImplies</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="entity"><span>phi2</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="entity"><span>phi1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATyQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AQuant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AConn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AIff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>strip_up_to_predicator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_term_order_weight</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2147483647</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atp_problem_term_order_info</span></span><span> </span><span class="entity"><span>problem</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_edge</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Graph.add_edge_acyclic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_user_symbol</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_user_symbol</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_edge</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AAbs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_intro_deps</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_ahorn_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_intro_deps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_atom_eq_deps</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ATerm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_tptp_equal</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_atom_eq_deps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eq_deps</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>strip_iff_etc</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>make_head_roll</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_term_deps</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>formula_fold</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Conjecture</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>add_atom_eq_deps</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_eq_deps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_isabelle_status</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>status</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Conjecture</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>role</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>graph</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Graph.empty</span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eq_deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>non_rec_defN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_eq_deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>rec_defN</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>simpN</span></span><span>
                                  </span><span>orf</span><span> </span><span class="entity"><span>is_conj</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_intro_deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>inductiveN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_intro_deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_status</span></span><span> </span><span class="entity"><span>introN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>problem</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_weight</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>w</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_term_order_weight</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_weights</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_weights</span></span><span> </span><span class="entity"><span>weight</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>weight</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>add_weights</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_weight</span></span><span> </span><span class="entity"><span>weight</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Graph.immediate_succs</span><span> </span><span class="entity"><span>graph</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="comment1"><span>(* Sorting is not just for aesthetics: It specifies the precedence order for
       the term ordering (KBO or LPO), from smaller to larger values. *)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_weights</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Graph.minimals</span><span> </span><span class="entity"><span>graph</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>