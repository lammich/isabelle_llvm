<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/record.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/record.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/record.ML
    Author:     Wolfgang Naraschewski, TU Muenchen
    Author:     Markus Wenzel, TU Muenchen
    Author:     Norbert Schirmer, TU Muenchen
    Author:     Norbert Schirmer, Apple, 2022
    Author:     Thomas Sewell, NICTA

Extensible records with structural subtyping.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>RECORD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_abbr</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> type_as_fields</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> timing</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>args</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    parent</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
    fields</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    extension</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    ext_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> ext_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> ext_surjective</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> ext_split</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> ext_def</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    select_convs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> update_convs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> select_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> update_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    fold_congs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> unfold_congs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> splits</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    surjective</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> equality</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> induct_scheme</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> cases_scheme</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> iffs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_info</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_info</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_hierarchy</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_record</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> last_extT</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_recTs</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_extT_fields</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_recT_fields</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_parent</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_extension</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_extinjects</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_simpset</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>simpset</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simproc</span><span class="main"><span>:</span></span><span> </span><span>simproc</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_simproc</span><span class="main"><span>:</span></span><span> </span><span>simproc</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> upd_simproc</span><span class="main"><span>:</span></span><span> </span><span>simproc</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_simproc</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>simproc</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ex_sel_eq_simproc</span><span class="main"><span>:</span></span><span> </span><span>simproc</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_simp_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_wrapper</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_recT</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_record</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> codegen</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sort_updates</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> updateN</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ext_typeN</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> extN</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ISO_TUPLE_SUPPORT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_iso_tuple_type</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_cons_tuple</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_cons_tuple</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> iso_tuple_intros_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Iso_Tuple_Support</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ISO_TUPLE_SUPPORT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isoN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_Tuple_Iso"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iso_tuple_intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.isomorphic_tuple_intro|fact"><span>isomorphic_tuple_intro</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iso_tuple_intros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.build_net</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.isomorphic_tuple.intros|fact"><span>isomorphic_tuple.intros</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tuple_iso_tuple</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.tuple_iso_tuple|const"><span>Record.tuple_iso_tuple</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.tuple_iso_tuple|fact"><span>tuple_iso_tuple</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Iso_Tuple_Thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>Symtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tuple_iso_tuple</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>   </span><span class="comment1"><span>(* FIXME handle Symtab.DUP ?? *)</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_typedef_info</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>rep_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Typedef.info</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exists_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>UNIV_I</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.global_ctyp_of</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.varifyT_global</span><span> </span><span class="entity"><span>rep_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proj_constr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exists_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proj_constr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_type</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>do_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>raw_tyco</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.check_tfree</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_vs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Named_Target.theory_map_result</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>o</span><span> </span><span class="entity"><span>Typedef.transform_info</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Typedef.add_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_UNIV</span></span><span> </span><span class="entity"><span>repT</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>UNIV_witness</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_typedef_info</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_cons_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_cons|const"><span>iso_tuple_cons</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span class="entity"><span>A</span></span></span><span> </span><span class="entity"><span class="entity"><span>B</span></span></span><span>›</span></span></span><span> </span><span class="entity"><span class="entity"><span>A</span></span></span><span> </span><span class="entity"><span class="entity"><span>B</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.tuple_iso_tuple|const"><span>tuple_iso_tuple</span></a><span> </span><span class="entity"><span class="entity"><span>A</span></span></span><span> </span><span class="entity"><span class="entity"><span>B</span></span></span><span>›</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_cons_tuple</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_cons|const"><span>iso_tuple_cons</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Const</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_cons_tuple</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_cons_tuple"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_iso_tuple_type</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>leftT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rightT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>leftT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rightT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_inverse</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>do_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>repT</span></span><span> </span><span class="entity"><span>alphas</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Sign.add_path</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*FIXME proper prefixing instead*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>typ_thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*construct a type and body for the isomorphism constant by
      instantiating the theorem to which the definition will be applied*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_inst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rep_inject</span></span><span> </span><span>RS</span><span>
        </span><span>infer_instantiate</span><span> </span><span class="entity"><span>typ_ctxt</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"abst"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>typ_ctxt</span></span><span> </span><span class="entity"><span>absC</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>iso_tuple_intro</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_equals</span><span> </span><span class="main"><span>(</span></span><span>List.last</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>intro_inst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isomT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isom_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="entity"><span>isoN</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isom_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.full_name</span><span> </span><span class="entity"><span>typ_thy</span></span><span> </span><span class="entity"><span>isom_binding</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isom_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isomT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>isom_def</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdef_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>typ_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>isom_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isomT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
      </span><span>|&gt;</span><span> </span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>isom_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iso_tuple</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isom_def</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_inverse</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_inject</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>iso_tuple_intro</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cons</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_cons|const"><span>iso_tuple_cons</span></a><span> </span><span class="entity"><span class="entity"><span>absT</span></span></span><span> </span><span class="entity"><span class="entity"><span>leftT</span></span></span><span> </span><span class="entity"><span class="entity"><span>rightT</span></span></span><span>›</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm_thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>cdef_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Iso_Tuple_Thms.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.insert</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isom_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iso_tuple</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.restore_naming</span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>isom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cons</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>isom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm_thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>resolve_from_net_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>iso_tuple_intros</span></span><span> </span><span>THEN'</span><span>
  </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cgoal</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Iso_Tuple_Thms.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"iso_tuple_intros_tac: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>goal'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Record.html#Record.isomorphic_tuple|const"><span>isomorphic_tuple</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Const</span><span> </span><span class="entity"><span>is</span></span><span>›</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="inner_quoted"><span>"unexpected goal format"</span></span><span> </span><span class="entity"><span>goal'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isthm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>isthms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>isthm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>isthm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="inner_quoted"><span>"no thm found for constant"</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>isthm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Record</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>RECORD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>surject_assistI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_surjective_proof_assistI|fact"><span>iso_tuple_surjective_proof_assistI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>surject_assist_idE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_surjective_proof_assist_idE|fact"><span>iso_tuple_surjective_proof_assist_idE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_accessor_eqE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_accessor_eqE|fact"><span>update_accessor_accessor_eqE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_updator_eqE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_updator_eqE|fact"><span>update_accessor_updator_eqE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_eq_idI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_update_accessor_eq_assist_idI|fact"><span>iso_tuple_update_accessor_eq_assist_idI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_eq_triv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_update_accessor_eq_assist_triv|fact"><span>iso_tuple_update_accessor_eq_assist_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_foldE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_congruence_foldE|fact"><span>update_accessor_congruence_foldE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_unfoldE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_congruence_unfoldE|fact"><span>update_accessor_congruence_unfoldE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_noopE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_noopE|fact"><span>update_accessor_noopE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_noop_compE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_noop_compE|fact"><span>update_accessor_noop_compE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_cong_idI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_cong_assist_idI|fact"><span>update_accessor_cong_assist_idI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_cong_triv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.update_accessor_cong_assist_triv|fact"><span>update_accessor_cong_assist_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updacc_cong_from_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.iso_tuple_update_accessor_cong_from_eq|fact"><span>iso_tuple_update_accessor_cong_from_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>codegen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Record.record_codegen|attribute"><span>record_codegen</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sort_updates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Record.record_sort_updates|attribute"><span>record_sort_updates</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** name components **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"r"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"w"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>moreN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"more"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schemeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_scheme"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_ext"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_typeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_inner"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"_ext"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updateN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_update"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>makeN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"make"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields_selN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"fields"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extendN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"extend"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>truncateN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"truncate"</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** utilities ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_type_tfree</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* timing *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timing</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Record.record_timing|attribute"><span>record_timing</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>timing</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span> </span><span>timeit</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>timing_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>timing</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> :== ===</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> ==&gt;</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>:==</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Misc_Legacy.mk_defpair</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>==&gt;</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_implies</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* constructor *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* selector *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_selC</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_selC</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* updates *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_updC</span></span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>sT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>sT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_upd'</span></span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_updC</span></span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>sT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_upd</span></span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_upd'</span></span><span> </span><span class="entity"><span>sfx</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* types *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_recT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c_ext_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c_ext_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Record.dest_recT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>List.last</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_recT</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Record.dest_recT"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_recT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_recT</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_recTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_recT</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>dest_recTs</span></span><span> </span><span class="entity"><span>U</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>last_extT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_recT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>last_extT</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_id</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_recTs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rTs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rTs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>take</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>rTs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>rTs'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** extend theory by record definition ***)</span></span><span>

</span><span class="comment1"><span>(** record info **)</span></span><span>

</span><span class="comment1"><span>(* type info and parent_info *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>args</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  parent</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
  fields</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  extension</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>

  ext_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  ext_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  ext_surjective</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  ext_split</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  ext_def</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>

  select_convs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  update_convs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  select_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  update_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  fold_congs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(* potentially used in L4.verified *)</span></span><span>
  unfold_congs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(* potentially used in L4.verified *)</span></span><span>
  splits</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>

  surjective</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  equality</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  induct_scheme</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  cases_scheme</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>

  simps</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  iffs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_info</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>extension</span></span><span>
    </span><span class="entity"><span>ext_induct</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span> </span><span class="entity"><span>ext_surjective</span></span><span> </span><span class="entity"><span>ext_split</span></span><span> </span><span class="entity"><span>ext_def</span></span><span>
    </span><span class="entity"><span>select_convs</span></span><span> </span><span class="entity"><span>update_convs</span></span><span> </span><span class="entity"><span>select_defs</span></span><span> </span><span class="entity"><span>update_defs</span></span><span> </span><span class="entity"><span>fold_congs</span></span><span> </span><span class="entity"><span>unfold_congs</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>defs</span></span><span>
    </span><span class="entity"><span>surjective</span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="entity"><span>cases_scheme</span></span><span> </span><span class="entity"><span>cases</span></span><span>
    </span><span class="entity"><span>simps</span></span><span> </span><span class="entity"><span>iffs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>args </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> parent </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> fields </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> extension </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>,</span></span><span>
  ext_induct </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_induct</span></span><span class="main"><span>,</span></span><span> ext_inject </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span class="main"><span>,</span></span><span> ext_surjective </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_surjective</span></span><span class="main"><span>,</span></span><span>
  ext_split </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_split</span></span><span class="main"><span>,</span></span><span> ext_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_def</span></span><span class="main"><span>,</span></span><span> select_convs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>select_convs</span></span><span class="main"><span>,</span></span><span>
  update_convs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_convs</span></span><span class="main"><span>,</span></span><span> select_defs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>select_defs</span></span><span class="main"><span>,</span></span><span> update_defs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_defs</span></span><span class="main"><span>,</span></span><span>
  fold_congs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_congs</span></span><span class="main"><span>,</span></span><span> unfold_congs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_congs</span></span><span class="main"><span>,</span></span><span> splits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> defs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span>
  surjective </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>surjective</span></span><span class="main"><span>,</span></span><span> equality </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equality</span></span><span class="main"><span>,</span></span><span> induct_scheme </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span class="main"><span>,</span></span><span>
  induct </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>,</span></span><span> cases_scheme </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cases_scheme</span></span><span class="main"><span>,</span></span><span> cases </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span> simps </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>,</span></span><span> iffs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>iffs</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parent_info</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
  fields</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  extension</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  induct_scheme</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  ext_def</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_parent_info</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>extension</span></span><span> </span><span class="entity"><span>ext_def</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parent_info</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> fields </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> extension </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>,</span></span><span>
  ext_def </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_def</span></span><span class="main"><span>,</span></span><span> induct_scheme </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* theory data *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>records</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
  sel_upd</span><span class="main"><span>:</span></span><span>
   </span><span class="main"><span>{</span></span><span>selectors</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
    updates</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
    simpset</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>,</span></span><span>
    defset</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
  equalities</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
  extinjects</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  extsplit</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*maps extension name to split rule*)</span></span><span>
  splits</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> * </span><span>thm</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*!!, ALL, EX - split-equalities, induct rule*)</span></span><span>
  extfields</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*maps extension to its fields*)</span></span><span>
  fieldext</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>  </span><span class="comment1"><span>(*maps field to its extension*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_data</span></span><span>
    </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>records </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> sel_upd </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span>
  equalities </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> extinjects</span><span class="main"><span>=</span></span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> extsplit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> splits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span>
  extfields </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> fieldext </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fieldext</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span>Symtab.empty</span><span>
      </span><span class="main"><span>{</span></span><span>selectors </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> updates </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
        simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span class="main"><span>,</span></span><span> defset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span class="main"><span>}</span></span><span>
       </span><span>Symtab.empty</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>Symtab.empty</span><span> </span><span>Symtab.empty</span><span> </span><span>Symtab.empty</span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>records </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>recs1</span></span><span class="main"><span>,</span></span><span>
     sel_upd </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>selectors </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sels1</span></span><span class="main"><span>,</span></span><span> updates </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>upds1</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ss1</span></span><span class="main"><span>,</span></span><span> defset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ds1</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
     equalities </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equalities1</span></span><span class="main"><span>,</span></span><span>
     extinjects </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extinjects1</span></span><span class="main"><span>,</span></span><span>
     extsplit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extsplit1</span></span><span class="main"><span>,</span></span><span>
     splits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>splits1</span></span><span class="main"><span>,</span></span><span>
     extfields </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extfields1</span></span><span class="main"><span>,</span></span><span>
     fieldext </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fieldext1</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>{</span></span><span>records </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>recs2</span></span><span class="main"><span>,</span></span><span>
     sel_upd </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>selectors </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sels2</span></span><span class="main"><span>,</span></span><span> updates </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>upds2</span></span><span class="main"><span>,</span></span><span> simpset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ss2</span></span><span class="main"><span>,</span></span><span> defset </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ds2</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
     equalities </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equalities2</span></span><span class="main"><span>,</span></span><span>
     extinjects </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extinjects2</span></span><span class="main"><span>,</span></span><span>
     extsplit </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extsplit2</span></span><span class="main"><span>,</span></span><span>
     splits </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>splits2</span></span><span class="main"><span>,</span></span><span>
     extfields </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extfields2</span></span><span class="main"><span>,</span></span><span>
     fieldext </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fieldext2</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recs2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>{</span></span><span>selectors </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sels1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sels2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        updates </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upds1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upds2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        simpset </span><span class="main"><span>=</span></span><span> </span><span>Simplifier.merge_ss</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ss1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ss2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        defset </span><span class="main"><span>=</span></span><span> </span><span>Simplifier.merge_ss</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ds2</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>equalities1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.merge_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extinjects1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extsplit1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
          </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>splits1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extfields1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fieldext1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'records' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>records </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown record type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_record</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>records</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'sel_upd' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_sel_upd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>sel_upd </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_selector</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.defined</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>selectors </span><span>o</span><span> </span><span class="entity"><span>get_sel_upd</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_updates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>updates </span><span>o</span><span> </span><span class="entity"><span>get_sel_upd</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_simpset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>simpset </span><span>o</span><span> </span><span class="entity"><span>get_sel_upd</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_sel_upd_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>defset </span><span>o</span><span> </span><span class="entity"><span>get_sel_upd</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_update_details</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_sel_upd</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>updates </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ismore</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>selectors </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ismore</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_sel_upd</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="entity"><span>simps</span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>more</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>updateN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>all</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> sel_upd </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>selectors</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defset</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span>
        </span><span class="main"><span>{</span></span><span>selectors </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Symtab.update_new</span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="entity"><span>selectors</span></span><span class="main"><span>,</span></span><span>
          updates </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Symtab.update_new</span><span> </span><span class="entity"><span>upds</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>,</span></span><span>
          simpset </span><span class="main"><span>=</span></span><span> </span><span>simpset_map</span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>simpset</span></span><span class="main"><span>,</span></span><span>
          defset </span><span class="main"><span>=</span></span><span> </span><span>simpset_map</span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defset</span></span><span class="main"><span>}</span></span><span>
         </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Data.put</span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'equalities' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_equalities</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_equalities</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>equalities </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'extinjects' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extinjects</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_extinjects</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>extinjects </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'extsplit' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extsplit</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'splits' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_splits</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>thmP</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmP</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_splits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>splits </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* parent/extension of named record *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_parent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Option.join</span><span> </span><span>o</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>parent</span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>records </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_extension</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>extension </span><span>oo</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>records </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'extfields' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extfields</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span>
      </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_extfields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>extfields </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_extT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_recT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recname</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nm</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>   </span><span class="comment1"><span>(* FIXME !? *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Long_Name.implode</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nm</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>maxidx_of_typs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>moreT</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>more</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup_list</span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>extension </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup</span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>recname</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>varifyT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>more</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_recT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root_fields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root_more</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>root_moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_extT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rest_fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest_more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_recT</span></span><span> </span><span class="entity"><span>root_moreT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_recT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>root_moreT</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root_more</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>root_moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>root_fields</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rest_fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest_more</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* access 'fieldext' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fieldext</span></span><span> </span><span class="entity"><span>extname_types</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>records</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equalities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extinjects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extsplit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fieldext'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>field</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extname_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>fieldext</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_data</span></span><span> </span><span class="entity"><span>records</span></span><span> </span><span class="entity"><span>sel_upd</span></span><span> </span><span class="entity"><span>equalities</span></span><span> </span><span class="entity"><span>extinjects</span></span><span> </span><span class="entity"><span>extsplit</span></span><span> </span><span class="entity"><span>splits</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>fieldext'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_fieldext</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fieldext </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* parent records *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_parents</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_parents</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" parent record "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="inner_quoted"><span>"Unknown"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>types</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="inner_quoted"><span>"Bad number of arguments for"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad_inst</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Sign.of_sort</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="entity"><span>bad_inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Ill-sorted instantiation of "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>bads</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" in"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.map_type_tfree</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_parents</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>parent'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_hierarchy</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_parents</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_parent_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_parents</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.map_type_tfree</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_def</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>make_parent_info</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>fields'</span></span><span> </span><span class="entity"><span>extension'</span></span><span> </span><span class="entity"><span>ext_def</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** concrete syntax for records **)</span></span><span>

</span><span class="comment1"><span>(* parse translations *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>field</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>fargs</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"expecting field "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>field</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" but got "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fargs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fargs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"expecting more fields"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_type_tr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_type›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_type_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"field_type_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_types_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_types›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>field_type_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>field_types_tr</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_types_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>field_type_tr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_field_types_tr</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Error in record-type input: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fargs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_fieldext</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.intern_const</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_extfields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>fields'</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>fields'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fargs</span></span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Fail</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argtypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_typs</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Syntax_Phases.decode_typ</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.maxidx_typ</span><span> </span><span class="entity"><span>argtypes</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vartypes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>;</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.raw_matches</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vartypes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>argtypes</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="inner_quoted"><span>"type is no proper record (extension)"</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alphas'</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax_Phases.term_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>varifyT</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>more'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span>list_comb</span><span>
                      </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="main"><span>(</span></span><span>Lexicon.mark_type</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no fields defined for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is no proper field"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_types_tr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_type_tr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_field_types_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_syntax</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>record_type_tr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"record_type_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_type_scheme_tr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_field_types_tr</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>record_type_scheme_tr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"record_type_scheme_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_tr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"field_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fields_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_fields›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>field_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fields_tr</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fields_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>field_tr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_fields_tr</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Error in record input: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fargs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_fieldext</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.intern_const</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_extfields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_args</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fargs</span></span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Fail</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>more'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="main"><span>(</span></span><span>Lexicon.mark_const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>extN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no fields defined for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is no proper field"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields_tr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_tr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_fields_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.Unity|const"><span>Unity</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>record_tr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"record_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_scheme_tr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_fields_tr</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>record_scheme_tr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"record_scheme_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_update_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_update›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Syntax.const</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>updateN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu_</span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_update_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"field_update_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_updates_tr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_updates›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>field_update_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>field_updates_tr</span></span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_updates_tr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>field_update_tr</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_update_tr</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_updates_tr</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>record_update_tr</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"record_update_tr"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span>Sign.parse_translation</span><span>
     </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_update›</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>record_update_tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>record_tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_scheme›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>record_scheme_tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_type›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>record_type_tr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_type_scheme›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>record_type_scheme_tr</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* print translations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_abbr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Record.record_type_abbr|attribute"><span>record_type_abbr</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_as_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Record.record_type_as_fields|attribute"><span>record_type_as_fields</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="comment1"><span>(* FIXME early extern (!??) *)</span></span><span>
</span><span class="comment1"><span>(* FIXME Syntax.free (??) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_type_tr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_type›</span></span><span> </span><span>$</span><span> </span><span>Syntax.const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_types_tr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_types›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_type_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax_Phases.decode_typ</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_of_typ</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>ext'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_extfields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ext'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_fieldext</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields'</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.extern_const</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>::</span><span>
                            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>Long_Name.base_name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alphavars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.raw_matches</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alphavars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apsnd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>varifyT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fields'</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fields''</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>foldr1</span><span> </span><span class="entity"><span>field_types_tr'</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_type_tr'</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Syntax_Phases.term_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_as_fields</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_type›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_type_scheme›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span>
        </span><span>Syntax_Phases.term_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>moreT</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*try to reconstruct the record name type abbreviation from
  the (nested) extension types*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_type_abbr_tr'</span></span><span> </span><span class="entity"><span>abbr</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="entity"><span>schemeT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax_Phases.decode_typ</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>maxidx_of_typ</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_type_abbr</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abbrT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varifyT</span></span><span> </span><span>o</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Syntax_Phases.term_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>abbrT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>rT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.raw_match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varifyT</span></span><span> </span><span class="entity"><span>rT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_abbr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>last_extT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>schemeT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>HOLogic.is_unitT</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>varifyT</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>zeta</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_type_abbr</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>abbr</span></span><span> </span><span class="entity"><span>alphas</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_type_abbr</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>schemeN</span></span><span> </span><span class="entity"><span>abbr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alphas</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>zeta</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>record_type_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span> </span><span class="comment1"><span>(*give print translation of specialised record a chance*)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>record_type_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_ext_type_tr'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_type_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Lexicon.mark_type</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>record_type_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="entity"><span>ext_type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_ext_type_abbr_tr'</span></span><span> </span><span class="entity"><span>abbr</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="entity"><span>schemeT</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_type_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Lexicon.mark_type</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>record_type_abbr_tr'</span></span><span> </span><span class="entity"><span>abbr</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="entity"><span>schemeT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="entity"><span>ext_type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="comment1"><span>(* FIXME Syntax.free (??) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_tr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field›</span></span><span> </span><span>$</span><span> </span><span>Syntax.const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fields_tr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_fields›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Lexicon.unmark_const</span><span> </span><span>o</span><span> </span><span>unsuffix</span><span> </span><span class="entity"><span>extN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>ext'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_extfields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ext'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.extern_const</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ListPair.UnequalLengths</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fields</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>fields_tr'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>field_tr'</span></span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_syntax</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.Unity|const"><span>Unity</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_scheme›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_ext_tr'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Lexicon.mark_const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>extN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="entity"><span>ext_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_update</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>Lexicon.unmark_const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>updateN</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.extern_const</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_updates_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_update</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>Syntax_Trans.const_abs_tr'</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_update›</span></span><span> </span><span>$</span><span> </span><span>Syntax.free</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>field_updates_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>field_updates_tr'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>record_update_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>field_updates_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_record_update›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span>
        </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.const</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">syntax_const</span><span class="hidden">&gt;</span></span></span><span>‹_field_updates›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_update_tr'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>update_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Lexicon.mark_const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>updateN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>record_update_tr'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.const</span><span> </span><span class="entity"><span>update_name</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tr'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tr'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** record simprocs **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_sel_upd_pair</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_updates</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>u_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>u_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"is_sel_upd_pair: not update"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_comp_id</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>range_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Fun.html#Fun.id|const"><span>id</span></a><span> </span><span class="entity"><span class="entity"><span>T</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_upd_funs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>get_upd_funs</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_upd_funs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_accupd_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort_distinct</span><span> </span><span>Term_Ord.fast_term_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_upd_funs</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_simp</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(* FIXME fresh "f" (!?) *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>upd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_sel_upd_pair</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>upd</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_comp_id</span></span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>othm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
              </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
              </span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.id_apply|fact"><span>id_apply</span></a><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.id_o|fact"><span>id_o</span></a><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_id|fact"><span>o_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_sel_upd_pair</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>upd</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_eq_dest|fact"><span>o_eq_dest</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_eq_id_dest|fact"><span>o_eq_id_dest</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Drule.export_without_context</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>othm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>get_simp</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_updupd_simp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* FIXME fresh "f" (!?) *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f'"</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>comp</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_comp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>othm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
          </span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.id_apply|fact"><span>id_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_eq_dest_lhs|fact"><span>o_eq_dest_lhs</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_eq_dest|fact"><span>o_eq_dest</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Drule.export_without_context</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>othm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_get_updupd_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>getswap</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_updupd_simp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_swaps_to_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>swaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swaps</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>build_swaps_to_eq</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>swaps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>upd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newswaps</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symreltab.defined</span><span> </span><span class="entity"><span>swaps</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>swaps</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Symreltab.insert</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>getswap</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>upd</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>swaps</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>newswaps</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>build_swaps_to_eq</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>newswaps</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>swaps_needed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>swaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Symreltab.dest</span><span> </span><span class="entity"><span>swaps</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>swaps_needed</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>swaps</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>swaps_needed</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>build_swaps_to_eq</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="entity"><span>swaps</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>swaps_needed</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prev</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.insert</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>swaps</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>swaps_needed</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>Symtab.empty</span><span> </span><span>Symreltab.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_updupd_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_get_updupd_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_upd_funs</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defset</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_unfold_defs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="entity"><span>ex_simps</span></span><span> </span><span class="entity"><span>ex_simprs</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_sel_upd_defs</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_equals</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_accupd_simps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>get_updupd_simps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>defset</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_get_updupd_simps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="entity"><span>defset</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop'</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simps</span></span><span> </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.K_record_comp|fact"><span>K_record_comp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>ex_simps</span></span><span> </span><span>addsimprocs</span><span> </span><span class="entity"><span>ex_simprs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_field</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.lookup_list</span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>eN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_recTs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kT</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>loose_bnos</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xT</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="comment1"><span>(* simproc *)</span></span><span>

</span><span class="comment1"><span>(*
  Simplify selections of an record update:
    (1)  S (S_update k r) = k (S r)
    (2)  S (X_update k r) = S r

  The simproc skips multiple updates at once, eg:
   S (X_update x (Y_update y (S_update k r))) = k (S r)

  But be careful in (2) because of the extensibility of records.
  - If S is a more-selector we have to make sure that the update on component
    X does not affect the selected subrecord.
  - If X is a more-selector we have to make sure that S is not in the updated
    subrecord.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.define_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>select_update</span><span>›</span></span></span><span>
   </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>x</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><span class="main"><span>{}</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rangeS</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_selector</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_updates</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>sel_upd </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>updates</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extfields</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>kT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>u_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_eq_terms</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"r"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rb</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="inner_quoted"><span>"k"</span></span><span> </span><span class="entity"><span>kT</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rb</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rv</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="inner_quoted"><span>"k"</span></span><span> </span><span class="entity"><span>kT</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kv</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_field</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>u_name</span></span><span> </span><span class="entity"><span>rangeS</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                            </span><span class="entity"><span>has_field</span></span><span> </span><span class="entity"><span>extfields</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>kT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_eq_terms</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="inner_quoted"><span>"k"</span></span><span> </span><span class="entity"><span>kT</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kv</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"r"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rb</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="inner_quoted"><span>"k"</span></span><span> </span><span class="entity"><span>kT</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>kb</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rb</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>kv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rv</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_eq_terms</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_eq_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>SOME</span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>prove_unfold_defs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                        </span><span class="main"><span>(</span></span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trm'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.check_simproc</span></span><span> </span><span class="main"><span>(</span></span><span>Context.the_local_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"select_update"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_upd_acc_cong_thm</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"upd"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>upd</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ac"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="entity"><span>updacc_cong_triv</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
        </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
        </span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_cong_idI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_unique</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_unique</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>insert_unique</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_unique_hd</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>insert_unique</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>xs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_unique_hd</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span>


</span><span class="comment1"><span>(* upd_simproc *)</span></span><span>

</span><span class="comment1"><span>(*Simplify multiple updates:
    (1) "N_update y (M_update g (N_update x (M_update f r))) =
          (N_update (y o x) (M_update (g o f) r))"
    (2)  "r(|M:= M r|) = r"

  In both cases "more" updates complicate matters: for this reason
  we omit considering further updates if doing so would introduce
  both a more update and an update to a field within it.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.define_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>update</span><span>›</span></span></span><span>
   </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>x</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><span class="main"><span>{}</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>
        </span><span class="comment1"><span>(*We can use more-updators with other updators as long
          as none of the other updators go deeper than any more
          updator. min here is the depth of the deepest other
          updator, max the depth of the shallowest more updator.*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>include_depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>min</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>dep</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>include_depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>min</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>min</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>getupdseq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>min</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_update_details</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ismore</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>include_depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ismore</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>min'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>getupdseq</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>min'</span></span><span> </span><span class="entity"><span>max'</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>getupdseq</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>baseT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>getupdseq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_upds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>upds</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev_order</span><span> </span><span>o</span><span> </span><span>fast_string_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>commuted</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>orig_upds</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sort_updates</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sorted</span></span><span> </span><span class="entity"><span>upd_ord</span></span><span> </span><span class="entity"><span>orig_upds</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="entity"><span>upd_ord</span></span><span> </span><span class="entity"><span>orig_upds</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>orig_upds</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_upd_noop</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>loose_bnos</span><span> </span><span class="entity"><span>tm'</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>subst_bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tm</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_upd_noop</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_noop_simps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_sel_upd_defs</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uathm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_upd_acc_cong_thm</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>[</span></span><span>Drule.export_without_context</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uathm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>updacc_noopE</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>Drule.export_without_context</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uathm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>updacc_noop_compE</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="comment1"><span>(*If f is constant then (f o g) = f.  We know that K_skeleton
          only returns constant abstractions thus when we see an
          abstraction we can discard inner updates.*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_upd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_upd</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="comment1"><span>(*mk_updterm returns
          (orig-term-skeleton-update list , simplified-skeleton,
            variables, duplicate-updates, simp-flag, noop-simps)

          where duplicate-updates is a table used to pass upward
          the list of update functions which can be composed
          into an update above them, simp-flag indicates whether
          any simplification was achieved, and noop-simps are
          used for eliminating case (2) defined above*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_updterm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>upds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>above</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>mk_updterm</span></span><span> </span><span class="entity"><span>upds</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>above</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skelf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>K_skeleton</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isnoop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skelf'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_upd_noop</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_comp_local</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Fun.html#Fun.comp|const"><span>Fun.comp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>funT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f'</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>isnoop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>skelf'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>noops</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>noops</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_noop_simps</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="entity"><span>skelf'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>above</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>skelf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_upd</span></span><span> </span><span class="entity"><span>skelf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>,</span></span><span>
                    </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>SOME</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>skelf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>mk_comp_local</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_upd</span></span><span> </span><span class="entity"><span>skelf</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>fvar</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>skelf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>skelf</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fvar</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_updterm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"r"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>baseT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_updterm</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_updterm match"</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_upds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_updterm</span></span><span> </span><span class="entity"><span>upds</span></span><span> </span><span>Symtab.empty</span><span> </span><span class="entity"><span>base</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_order_lhs_upds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs_upds</span></span><span> </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>orig_order_lhs_upds</span></span><span>
        </span><span class="comment1"><span>(* Note that the simplifier works bottom up. So all nested updates are already
           normalised, e.g. sorted. 'commuted' thus means that the outermost update has to be
           inserted at its place inside the sorted nested updates. The necessary swaps can be
           expressed via 'upd_funs' by replicating the outer update at the designated position: *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>commuted</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>insert_unique_hd</span></span><span> </span><span class="entity"><span>upd_ord</span></span><span> </span><span class="entity"><span>orig_upds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>orig_upds</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>noops'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="entity"><span>noops</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>commuted</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>SOME</span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>prove_unfold_defs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>upd_funs</span></span><span> </span><span class="entity"><span>noops'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>simproc</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>(</span></span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_simproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.check_simproc</span></span><span> </span><span class="main"><span>(</span></span><span>Context.the_local_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"update"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* eq_simproc *)</span></span><span>

</span><span class="comment1"><span>(*Look up the most specific record-equality.

 Note on efficiency:
 Testing equality of records boils down to the test of equality of all components.
 Therefore the complexity is: #components * complexity for single component.
 Especially if a record has a lot of components it may be better to split up
 the record first and do simplification on that (split_simp_tac).
 e.g. r(|lots of updates|) = x

             eq_simproc          split_simp_tac
 Complexity: #components * #updates     #updates
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.define_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>eq</span><span>›</span></span></span><span>
   </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>r</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>s</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rec_id</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_equalities</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.Eq_TrueI|fact"><span>Eq_TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_simproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.check_simproc</span></span><span> </span><span class="main"><span>(</span></span><span>Context.the_local_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"eq"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* split_simproc *)</span></span><span>

</span><span class="comment1"><span>(*Split quantified occurrences of records, for which P holds.  P can peek on the
  subterm starting at the quantified occurrence of the record (including the quantifier):
    P t = 0: do not split
    P t = ~1: completely split
    P t &gt; 0: split up to given bound of record extensions.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_simproc</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Simplifier.make_simproc</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="inner_quoted"><span>"record_split"</span></span><span>
   </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>x</span></span><span class="main"><span>::</span></span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><span class="main"><span>{}</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quantifier</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>quantifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="entity"><span>quantifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="entity"><span>quantifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rec_id</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_splits</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_id</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>All_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ex_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span>SOME</span><span>
                          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>quantifier</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                            </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>all_thm</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>All_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Ex_thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"split_simproc"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.define_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>ex_sel_eq</span><span>›</span></span></span><span>
   </span><span class="main"><span>{</span></span><span>lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="free"><span>t</span></span><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_selector</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.is_dependent</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>range_type</span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span class="entity"><span>T</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_sel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_sel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tsel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_sel_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mkeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_sel_eq</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span>Logic.list_all</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"r"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_simpset</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
                    </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.simp_thms|fact"><span>simp_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_simproc</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex_sel_eq_simproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.check_simproc</span></span><span> </span><span class="main"><span>(</span></span><span>Context.the_local_context</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ex_sel_eq"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>map_theory_simpset</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>delsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ex_sel_eq_simproc</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* split_simp_tac *)</span></span><span>

</span><span class="comment1"><span>(*Split (and simplify) all records in the goal for which P holds.
  For quantified occurrences of a record
  P can peek on the whole subterm (including the quantifier); for free variables P
  can only peek on the variable itself.
  P t = 0: do not split
  P t = ~1: completely split
  P t &gt; 0: split up to given bound of record extensions.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_simp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cgoal</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_recT</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_rec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists_Const</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_recT</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_free_tac</span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="entity"><span>induct_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>induct_thm</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>free</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>induct_thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.induct_atomize|fact"><span>induct_atomize</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
        </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.induct_rulify|fact"><span>induct_rulify</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_frees_tacs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>frees</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rec_id</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>free</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_splits</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_id</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_split_free_tac</span></span><span> </span><span class="entity"><span>free</span></span><span> </span><span class="entity"><span>induct_thm</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simprocs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_rec</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_simproc</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span> </span><a class="entity_ref" href="../../../../Record.html#Record.K_record_comp|fact"><span>K_record_comp</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>EVERY</span><span> </span><span class="entity"><span>split_frees_tacs</span></span><span> </span><span>THEN</span><span>
    </span><span class="entity"><span>full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_simpset</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms'</span></span><span> </span><span>addsimprocs</span><span> </span><span class="entity"><span>simprocs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* split_tac *)</span></span><span>

</span><span class="comment1"><span>(*Split all records in the goal, which are quantified by !! or ALL.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cgoal</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_rec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists_Const</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_recT</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_all</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_all</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_all</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_rec</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_simproc</span></span><span> </span><span class="entity"><span>is_all</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>no_tac</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* wrapper *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"record_split_tac"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_wrapper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>split_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** theory extender interface **)</span></span><span>

</span><span class="comment1"><span>(* attributes *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_names_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rule_Cases.case_names</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"fields"</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>induct_type_global</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_names_fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Induct.induct_type</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cases_type_global</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_names_fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Induct.cases_type</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* tactics *)</span></span><span>

</span><span class="comment1"><span>(*Do case analysis / induction according to rule on last parameter of ith subgoal
  (or on s if there are no parameters).
  Instatiation of record variable (and predicate) in rule is calculated to
  avoid problems with higher order unification.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cgoal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cgoal</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_params</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.lift_rule</span><span> </span><span class="entity"><span>cgoal</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="comment1"><span>(*ca indicates if rule is a case analysis or induction rule*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ca</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
          </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_hyp</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule''</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"try_param_tac: no such variable"</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ca</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>params</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ca</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>compose_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule''</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extension_definition</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fieldTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields_moreTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fieldTs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>moreT</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alphas_zeta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>zeta</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>base_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>suffix</span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>suffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>alphas_zeta</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fields_moreTs</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* the tree of new types that will back the record extension *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mktreeV</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Balanced_Tree.make</span><span> </span><span class="entity"><span>Iso_Tuple_Support.mk_cons_tuple</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_iso_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>right</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>suff</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>inner_typeN</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cons</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Iso_Tuple_Support.add_iso_tuple_type</span></span><span> </span><span class="entity"><span>overloaded</span></span><span>
            </span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="entity"><span>suff</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>base_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas_zeta</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>left</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>right</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>cons</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>left</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>right</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*trying to create a 1-element iso_tuple will fail, and is pointless anyway*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_even_iso_tuple</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>pair</span><span> </span><span class="entity"><span>arg</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_even_iso_tuple</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_iso_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.dest_cons_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mktreeV</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_meta_tree_type</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"meta_tree_type args too short"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>group16</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>group16</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>group16</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="inner_numeral"><span>16</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>group16</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>composites</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>mk_even_iso_tuple</span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>build_meta_tree_type</span></span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="entity"><span>composites</span></span><span> </span><span class="entity"><span>more</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_iso_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mktreeV</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timing_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension preparing definitions"</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* 1st stage part 1: introduce the tree of new types *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension nested type def:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>build_meta_tree_type</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* prepare declarations and definitions *)</span></span><span>

    </span><span class="comment1"><span>(* 1st stage part 2: define the ext constant *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_body</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>ext_def</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension constructor def:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>typ_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ext_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
      </span><span>|&gt;</span><span> </span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>ext_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_spec</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* prepare propositions *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timing_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension preparing propositions"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>variants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars_more</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>vars_more</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inject_prop</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="comment1"><span>(* FIXME local x x' *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars_more'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars_more</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span>$</span><span>
          </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>vars_more</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="entity"><span>vars_more'</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>===</span></span><span>
        </span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars_more</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>vars_more'</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>vars_more</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_meta_prop</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="comment1"><span>(* FIXME local P *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span>--&gt;</span><span> </span><span>propT</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>vars_more</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inject</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension inject proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>inject_prop</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ext_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
            </span><span>REPEAT_DETERM</span><span>
              </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.refl_conj_eq|fact"><span>refl_conj_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>ORELSE</span><span>
                </span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>ORELSE</span><span>
                </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(*We need a surjection property r = (| f = f r, g = g r ... |)
      to prove other theorems. We haven't given names to the accessors
      f, g etc yet however, so we generate an ext structure with
      free variables as all arguments and allow the introduction tactic to
      operate on it as far as it can. We then use Drule.export_without_context
      to convert the free variables into unifiable variables and unify them with
      (roughly) the definition of the accessor.*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>surject</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension surjective proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>infer_instantiate</span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>surject_assist_idE</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tactic1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ext_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tactic2</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surject_assistI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>halfway</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.list_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tactic1</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surject</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.list_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tactic2</span></span><span> </span><span class="main"><span>(</span></span><span>Drule.export_without_context</span><span> </span><span class="entity"><span>halfway</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>surject</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_meta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension split_meta proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>split_meta_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>EVERY1</span><span>
           </span><span class="main"><span>[</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><span>equal_intr_rule</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
            </span><span>Goal.norm_hhf_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span>
            </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Pure/Pure/Pure.html#Pure.meta_allE|fact"><span>meta_allE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.prop_subst|fact"><span>prop_subst</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surject</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span>REPEAT</span><span> </span><span>o</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Pure/Pure/Pure.html#Pure.meta_allE|fact"><span>meta_allE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"record extension induct proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct_prop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>assm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>cut_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_meta</span></span><span> </span><span>RS</span><span> </span><span>Drule.equal_elim_rule2</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>THEN</span><span>
            </span><span class="entity"><span>asm_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inject'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surjective'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_meta'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>defs_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Global_Theory.note_thmss</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"ext_induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>induct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"ext_inject"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>inject</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"ext_surjective"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>surject</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"ext_split"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>split_meta</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ext_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_type</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alphas_zeta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>extT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inject'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>surjective'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_meta'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm_thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>xs</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_last</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"chop_last: list should not be empty"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chop_last</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chop_last</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_last</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"subst_last: list should not be empty"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* mk_recordT *)</span></span><span>

</span><span class="comment1"><span>(*build up the record type from the current extension tpye extT and a list
  of parent extensions, starting with the root of the record hierarchy*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_recordT</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* code generation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_random_eq</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* FIXME local i etc. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>i</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent_names</span><span> </span><span>Name.context</span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_random</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_return</span></span><span> </span><span class="entity"><span>Tm</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_valtermify_app</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>HOLogic.mk_ST</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_random</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>tc</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>Tm</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_full_exhaustive_eq</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* FIXME local i etc. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="free"><span>i</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><a class="entity_ref" href="../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>test_function</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.prod|type"><span>×</span></a></span><span> </span><a class="entity_ref" href="../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span> </span><a class="entity_ref" href="../../../../List.html#List.list|type"><span>list</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent_names</span><span> </span><span>Name.context</span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_full_exhaustive</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Quickcheck_Exhaustive.html#Quickcheck_Exhaustive.full_exhaustive_class.full_exhaustive|const"><span>full_exhaustive_class.full_exhaustive</span></a><span> </span><span class="entity"><span>U</span></span><span>›</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_full_exhaustive</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>test_function</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>test_function</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_valtermify_app</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cont</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>mk_full_exhaustive</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>termifyT</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cont</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>tc</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_sort_record</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Class.instantiation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>tyco</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>snd</span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Class.prove_instantiation_exit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Class.intro_classes_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ensure_sort_record</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extN</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.classes_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sorts.has_instance</span><span> </span><span class="entity"><span>algebra</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_inst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Quickcheck_Common.perhaps_constrain</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>instantiate_sort_record</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sort</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extN</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>map_atyps</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_code</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>simps</span></span><span> </span><span class="entity"><span>inject</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>codegen</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.equal_class.equal|const"><span>HOL.equal</span></a><span> </span><span class="entity"><span class="entity"><span>extT</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span class="entity"><span>extT</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_def</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Class.intro_classes_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span>THEN</span><span> </span><span>rewrite_goals_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Simpdata.mk_eq</span></span><span> </span><span class="entity"><span>eq_def</span></span><span class="main"><span>]</span></span><span>
        </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.refl|fact"><span>refl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_def</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>Axclass.unoverload</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simpdata.mk_eq</span></span><span> </span><span class="entity"><span>eq_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>inject</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq_refl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="tfree"><span>'a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.varifyT_global</span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="main"><span>(</span></span><span>schematic</span><span class="main"><span>)</span></span><span> </span><span class="quoted"><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.equal_class.equal|const"><span>equal_class.equal</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.iff|const"><span>⟷</span></a></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.equal_class.equal_refl|fact"><span>equal_refl</span></a><span class="main"><span>)</span></span><span>›</span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Axclass.unoverload</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ensure_random_record</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ensure_sort_record</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Quickcheck_Random.html#Quickcheck_Random.random|class"><span>random</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_random_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ensure_exhaustive_record</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>ensure_sort_record</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Quickcheck_Exhaustive.html#Quickcheck_Exhaustive.full_exhaustive|class"><span>full_exhaustive</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_full_exhaustive_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_code</span></span><span> </span><span class="entity"><span>eq_def</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thy</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eq_def</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq_refl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_datatype_global</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ext</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Class.instantiation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>ext_tyco</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.class_equal</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Specification.definition</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="entity"><span>Class.prove_instantiation_exit_result</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>eq_def</span></span><span class="main"><span>)</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="entity"><span>add_code</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>ensure_random_record</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>ensure_exhaustive_record</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_ctr_sugar</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="entity"><span>exhaust</span></span><span> </span><span class="entity"><span>inject</span></span><span> </span><span class="entity"><span>sel_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Ctr_Sugar.default_register_ctr_sugar_global</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>{</span></span><span>kind </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ctr_Sugar.Record</span></span><span class="main"><span>,</span></span><span> T </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> ctrs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> casex </span><span class="main"><span>=</span></span><span> </span><span>Term.dummy</span><span class="main"><span>,</span></span><span>
     discs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> selss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> exhaust </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>,</span></span><span> nchotomy </span><span class="main"><span>=</span></span><span> </span><span>Drule.dummy_thm</span><span class="main"><span>,</span></span><span> injects </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inject</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     distincts </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> case_thms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> case_cong </span><span class="main"><span>=</span></span><span> </span><span>Drule.dummy_thm</span><span class="main"><span>,</span></span><span> case_cong_weak </span><span class="main"><span>=</span></span><span> </span><span>Drule.dummy_thm</span><span class="main"><span>,</span></span><span>
     case_distribs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> split </span><span class="main"><span>=</span></span><span> </span><span>Drule.dummy_thm</span><span class="main"><span>,</span></span><span> split_asm </span><span class="main"><span>=</span></span><span> </span><span>Drule.dummy_thm</span><span class="main"><span>,</span></span><span> disc_defs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     disc_thmss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> discIs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> disc_eq_cases </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> sel_defs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> sel_thmss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sel_thms</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     distinct_discsss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> exhaust_discs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> exhaust_sels </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> collapses </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> expands </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     split_sels </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> split_sel_asms </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> case_eq_ifs </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lhs_of_equation</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lhs_of_equation</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_spec_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_of_equation</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Spec_Rules.add_global</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>head</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* definition *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>definition</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alphas</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parents</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parent_info</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>thy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.full_name</span><span> </span><span class="entity"><span>thy0</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.full_name_path</span><span> </span><span class="entity"><span>thy0</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bfields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>field_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>fields </span><span class="entity"><span>parents</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_chunks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fields</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>parent_fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>parent_fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_fields_len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>parent_fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_variants</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wN</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>parent_names</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent_variants</span></span><span> </span><span class="entity"><span>parent_types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>full</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bfields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alphas_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>types</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alphas_ext</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>alphas_fields</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>variants</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>moreN</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rN</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>wN</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>parent_variants</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bfields</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>variants</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idxms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>len</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_fields</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_types</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_variants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_variants</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>variants</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_vars</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_named_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>parent_vars</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>named_vars</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"'z"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>zeta</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_moreN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>moreN</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bfields_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bfields</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>full_moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_vars_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>named_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>full_moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_named_vars_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_named_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>full_moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* 1st stage: ext_thy *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext_tyco</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>extT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_surjective</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_split</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>thy0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.qualified_path</span><span> </span><span>false</span><span> </span><span class="entity"><span>binding</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>extension_definition</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>extension_name</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>alphas_ext</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>ext_thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timing_msg</span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record preparing definitions"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="entity"><span>extension_scheme</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unsuffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>extension_scheme</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extension_scheme</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>unsuffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>extension</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>extension_name</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extension_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implode</span><span> </span><span class="entity"><span>extension_names</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_schemeT</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_recordT</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>extension </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extT</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_schemeT</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>recT</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extension</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>mk_recordT</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>extension </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_last</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recT0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>recT</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chop_last</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ext'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_ext'</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>extension_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>chunks</span></span><span> </span><span class="entity"><span>parent_chunks</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>more</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.unit</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>build</span></span><span> </span><span class="main"><span>(</span></span><span>map_range</span><span> </span><span class="entity"><span>recT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent_len</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>build</span></span><span> </span><span class="main"><span>(</span></span><span>map_range</span><span> </span><span class="entity"><span>rec_schemeT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent_len</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_rec0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_rec_unit0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>r_unit</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recT</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_unit0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r_unit</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* print translations *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>record_ext_type_abbr_tr's</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>extension_names</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unsuffix</span><span> </span><span class="entity"><span>ext_typeN</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>record_ext_type_abbr_tr'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>zeta</span></span><span> </span><span class="entity"><span>last_ext</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span class="entity"><span>trname</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>record_ext_type_tr's</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(*avoid conflict with record_type_abbr_tr's*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>parent_len</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>extension_name</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>record_ext_type_tr'</span></span><span> </span><span class="entity"><span>trnames</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>print_translation</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="entity"><span>field_update_tr'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_moreN</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>record_ext_tr'</span></span><span> </span><span class="entity"><span>extension_name</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
      </span><span class="entity"><span>record_ext_type_tr's</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>record_ext_type_abbr_tr's</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* prepare declarations *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_selC</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>Binding.name_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bfields_more</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_updC</span></span><span> </span><span class="entity"><span>updateN</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>Binding.name_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bfields_more</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>makeN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_types</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>recT0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields_decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields_selN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span>---&gt;</span><span> </span><span>Type</span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extend_decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extendN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>truncate_decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>truncateN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>recT0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* prepare definitions *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ext_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ext_def</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ext_def </span><span class="entity"><span>parents</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*Theorems from the iso_tuple intros.
      By unfolding ext_defs from r_rec0 we create a tree of constructor
      calls (many of them Pair, but others as well). The introduction
      rules for update_accessor_eq_assist can unify two different ways
      on these constructors. If we take the complete result sequence of
      running a the introduction tactic, we get one theorem for each upd/acc
      pair, from which we can derive the bodies of our selector and
      updator and their convs.*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accessor_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updator_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd_acc_cong_assists</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record getting tree access/updates:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r_rec0_Vars</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="comment1"><span>(*pick variable indices of 1 to avoid possible variable
                collisions with existing variables in updacc_eq_triv*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_Var</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>to_Var</span></span><span> </span><span class="entity"><span>all_vars_more</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ext_ctxt</span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"v"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"v'"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="entity"><span>r_rec0_Vars</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="entity"><span>updacc_eq_triv</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>terminal</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_eq_idI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>ext_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
            </span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>terminal</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>updaccs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.list_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tactic</span></span><span> </span><span class="entity"><span>init_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>updaccs</span></span><span> </span><span>RL</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_accessor_eqE</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>updaccs</span></span><span> </span><span>RL</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_updator_eqE</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>updaccs</span></span><span> </span><span>RL</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_cong_from_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lastN</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>drop</span><span> </span><span class="entity"><span>parent_fields_len</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*selectors*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sel_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>r_rec0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_sel_spec: different arg"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_selC</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>:==</span></span><span> </span><span class="entity"><span>acc</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_sel_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields_more</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>lastN</span></span><span> </span><span class="entity"><span>accessor_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*updates*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_upd_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upd</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>r_rec0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_sel_spec: different arg"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_updC</span></span><span> </span><span class="entity"><span>updateN</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>:==</span></span><span> </span><span class="entity"><span>upd</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_upd_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields_more</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>lastN</span></span><span> </span><span class="entity"><span>updator_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*derived operations*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>makeN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_types</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>recT0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>:==</span></span><span>
        </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>fields_selN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span> </span><span>---&gt;</span><span> </span><span>Type</span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>:==</span></span><span>
        </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vars</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent_len</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extend_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>extendN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_unit0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>more</span></span><span> </span><span class="entity"><span>:==</span></span><span>
        </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>r_unit0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_fields</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>more</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>truncate_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>truncateN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>recT0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="entity"><span>:==</span></span><span>
        </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_fields</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* 2st stage: defs_thy *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derived_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>ext_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record trfuns/tyabbrs/selectors/updates/make/fields/extend/truncate defs:"</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>ext_thy</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Sign.print_translation</span><span> </span><span class="entity"><span>print_translation</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Sign.restore_naming</span><span> </span><span class="entity"><span>thy0</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Typedecl.abbrev_global</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>alphas</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recT0</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Typedecl.abbrev_global</span></span><span>
            </span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="entity"><span>schemeN</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alphas</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>zeta</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span>
          </span><span>|&gt;</span><span> </span><span>snd</span><span>
          </span><span>|&gt;</span><span> </span><span>Sign.qualified_path</span><span> </span><span>false</span><span> </span><span class="entity"><span>binding</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>sel_decls</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_syntax</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>NoSyn</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Sign.declare_const_global</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>upd_decls</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>make_decl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fields_decl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extend_decl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>truncate_decl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span> </span><span>o</span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.no_attributes</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span>o</span><span> </span><span>Binding.name</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_specs</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span> </span><span>o</span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.no_attributes</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span>o</span><span> </span><span>Binding.name</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>upd_specs</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span> </span><span>o</span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.no_attributes</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span>o</span><span> </span><span>Binding.name</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>make_spec</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fields_spec</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extend_spec</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>truncate_spec</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* prepare propositions *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timing_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record preparing propositions"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"C"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_unit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recT0</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*selectors*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_conv_props</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>r_rec0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>named_vars_more</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*updates*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_upd_prop</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_variants</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_fields_len</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth_map</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span> </span><span>$</span><span> </span><span>nth</span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_vars_more</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_upd</span></span><span> </span><span class="entity"><span>updateN</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="entity"><span>r_rec0</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="entity"><span>args'</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upd_conv_props</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_upd_prop</span></span><span> </span><span class="entity"><span>idxms</span></span><span> </span><span class="entity"><span>fields_more</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*induct*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_scheme_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>==&gt;</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>all_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P_unit</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_rec_unit0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P_unit</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_unit0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*surjective*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>surjective_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_named_vars_more</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>mk_rec</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*cases*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases_scheme_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>r0</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>==&gt;</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>all_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>r_unit0</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>r_rec_unit0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>==&gt;</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>==&gt;</span></span><span> </span><span class="entity"><span>Trueprop</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*split*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_meta_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_variants</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span> </span><span>--&gt;</span><span> </span><span>propT</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>all_vars_more</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_object_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ALL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ALL</span></span><span> </span><span class="main"><span>[</span></span><span>dest_Free</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>ALL</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>all_vars_more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_ex_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>EX</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_exists</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>EX</span></span><span> </span><span class="main"><span>[</span></span><span>dest_Free</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>EX</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>all_vars_more</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r_rec0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(*equality*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equality_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_schemeT0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>mk_sel</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>seleqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_sel_eq</span></span><span> </span><span class="entity"><span>all_named_vars_more</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.all</span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seleqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r0</span></span><span> </span><span class="entity"><span>===</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* 3rd stage: thms_thy *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>record_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_simpset</span></span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_upd_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>simpset_of</span><span>
        </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>record_ss</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span>
          </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>accessor_thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_defs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>updator_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_convs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd_convs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record sel_convs/upd_convs proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>grouped</span><span> </span><span class="inner_numeral"><span>10</span></span><span> </span><span>Par_List.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>sel_upd_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>sel_conv_props</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_conv_props</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>chop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>sel_conv_props</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_congs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_congs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record upd fold/unfold congs:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>symdefs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Thm.symmetric</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fold_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>symdefs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ua_congs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Drule.export_without_context</span><span> </span><span>o</span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="entity"><span>fold_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>upd_acc_cong_assists</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ua_congs</span></span><span> </span><span>RL</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_foldE</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ua_congs</span></span><span> </span><span>RL</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>updacc_unfoldE</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>induct_scheme </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>List.last</span><span> </span><span class="entity"><span>parents</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record induct_scheme proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>induct_scheme_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>EVERY</span><span>
           </span><span class="main"><span>[</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parent_induct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>all_tac</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span class="entity"><span>ext_induct</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>asm_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record induct proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>induct_prop</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>induct_prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span class="entity"><span>induct_scheme</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span>THEN</span><span> </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_quoted"><span>"more"</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.unit.induct|fact"><span>unit.induct</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span>THEN</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>surjective</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record surjective proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>surjective_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>EVERY</span><span>
           </span><span class="main"><span>[</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surject_assist_idE</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>ext_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
            </span><span>REPEAT</span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Iso_Tuple_Support.iso_tuple_intros_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>ORELSE</span><span>
                </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surject_assistI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
                  </span><span class="entity"><span>simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_sel_upd_defs</span></span><span> </span><span class="entity"><span>defs_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
                    </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span> </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_assoc|fact"><span>o_assoc</span></a><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.id_apply|fact"><span>id_apply</span></a><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.id_o|fact"><span>id_o</span></a><span> </span><a class="entity_ref" href="../../../../Fun.html#Fun.o_id|fact"><span>o_id</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases_scheme</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record cases_scheme proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>cases_scheme_prop</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>cases_scheme_prop</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surjective</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record cases proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cases_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>try_param_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rN</span></span><span> </span><span class="entity"><span>cases_scheme</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asm_full_simp_tac</span></span><span>
            </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Product_Type.html#Product_Type.unit_all_eq1|fact"><span>unit_all_eq1</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_meta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record split_meta proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>split_meta_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>EVERY1</span><span>
           </span><span class="main"><span>[</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><span>equal_intr_rule</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>Goal.norm_hhf_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span>
            </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Pure/Pure/Pure.html#Pure.meta_allE|fact"><span>meta_allE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span>
            </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Record.html#Record.prop_subst|fact"><span>prop_subst</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surjective</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
            </span><span>REPEAT</span><span> </span><span>o</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Pure/Pure/Pure.html#Pure.meta_allE|fact"><span>meta_allE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_object</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record split_object proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>split_object_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="free"><span>B</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>B</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.iffI|fact"><span>iffI</span></a><span class="main"><span>)</span></span><span> </span><span class="operator"><span>unfold</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>rewrite_goals_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.atomize_all|fact"><span>atomize_all</span></a><span> </span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>THEN</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_meta</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_ex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record split_ex proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>split_ex_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>simp_tac</span></span><span>
            </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span>
              </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>∃</span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>.</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>x</span></span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../HOL.html#HOL.Not|const"><span>¬</span></a></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>x</span></span><span class="main"><span>)</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="operator"><span>simp</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span>
                </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.not_not|fact"><span>not_not</span></a><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.Not_eq_iff|fact"><span>Not_eq_iff</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span>
          </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_object</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>timeit_msg</span></span><span> </span><span class="entity"><span>defs_ctxt</span></span><span> </span><span class="inner_quoted"><span>"record equality proof:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Goal.prove_sorry_global</span><span> </span><span class="entity"><span>defs_thy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>equality_prop</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>record_ss</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_meta</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sel_convs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_convs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd_convs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upd_defs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_congs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_congs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>splits'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_meta'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_object'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_ex'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derived_defs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>surjective'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>equality'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct_scheme'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cases_scheme'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cases'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms_thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>defs_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>derived_defs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Global_Theory.note_thmss</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
       </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"select_convs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>sel_convs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"update_convs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd_convs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"select_defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"update_defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>upd_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"fold_congs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>fold_congs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"unfold_congs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>unfold_congs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"splits"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>split_meta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_object</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_ex</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>derived_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"surjective"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>surjective</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"equality"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>equality</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"induct_scheme"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_type_global</span></span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>schemeN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>induct_scheme</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_type_global</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>induct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"cases_scheme"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cases_type_global</span></span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span class="entity"><span>schemeN</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>cases_scheme</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"cases"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cases_type_global</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>cases</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_upd_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_convs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_convs'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_upd_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_defs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_defs'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parent_len</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iffs'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms_thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thms_thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Global_Theory.note_thmss</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"simps"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Simplifier.simp_add</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>sel_upd_simps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"iffs"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>iff_add</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>ext_inject</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>make_info</span></span><span> </span><span class="entity"><span>alphas</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="entity"><span>extension</span></span><span>
        </span><span class="entity"><span>ext_induct</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span> </span><span class="entity"><span>ext_surjective</span></span><span> </span><span class="entity"><span>ext_split</span></span><span> </span><span class="entity"><span>ext_def</span></span><span>
        </span><span class="entity"><span>sel_convs'</span></span><span> </span><span class="entity"><span>upd_convs'</span></span><span> </span><span class="entity"><span>sel_defs'</span></span><span> </span><span class="entity"><span>upd_defs'</span></span><span> </span><span class="entity"><span>fold_congs'</span></span><span> </span><span class="entity"><span>unfold_congs'</span></span><span> </span><span class="entity"><span>splits'</span></span><span> </span><span class="entity"><span>derived_defs'</span></span><span>
        </span><span class="entity"><span>surjective'</span></span><span> </span><span class="entity"><span>equality'</span></span><span> </span><span class="entity"><span>induct_scheme'</span></span><span> </span><span class="entity"><span>induct'</span></span><span> </span><span class="entity"><span>cases_scheme'</span></span><span> </span><span class="entity"><span>cases'</span></span><span> </span><span class="entity"><span>simps'</span></span><span> </span><span class="entity"><span>iffs'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>final_thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>thms_thy'</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>put_record</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>info</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>put_sel_upd</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>full_moreN</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="entity"><span>sel_upd_simps</span></span><span> </span><span class="entity"><span>sel_upd_defs</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_equalities</span></span><span> </span><span class="entity"><span>extension_id</span></span><span> </span><span class="entity"><span>equality'</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_extinjects</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_extsplit</span></span><span> </span><span class="entity"><span>extension_name</span></span><span> </span><span class="entity"><span>ext_split</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_splits</span></span><span> </span><span class="entity"><span>extension_id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_meta'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_object'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_ex'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_scheme'</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_extfields</span></span><span> </span><span class="entity"><span>extension_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>full_moreN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_fieldext</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extension_name</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>extension</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_code</span></span><span> </span><span class="entity"><span>ext_tyco</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>extT</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>simps'</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_ctr_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cases_scheme'</span></span><span> </span><span class="entity"><span>ext_inject</span></span><span> </span><span class="entity"><span>sel_convs'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_spec_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_convs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>upd_convs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>derived_defs'</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Sign.restore_naming</span><span> </span><span class="entity"><span>thy0</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>final_thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* add_record *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_parent</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>read_parent</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Proof_Context.read_typ_abbrev</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad parent record specification: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_fields</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_typs</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_record</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_parent</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cert_typ</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.no_tvars</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.cert_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* specification *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cert_typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_parent</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>cat_error</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The error(s) above occurred in parent record specification"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_parent_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>parent</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bfields</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>raw_fields</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cert_typ</span></span><span> </span><span class="entity"><span>raw_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>cat_error</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The error(s) above occurred in record field "</span></span><span> </span><span>^</span><span> </span><span>Binding.print</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* errors *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.full_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_dup_record</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_none</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Duplicate definition of record "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent_args</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>bfields</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_extra_frees</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>spec_frees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Extra free type variable(s) "</span></span><span> </span><span>^</span><span>
          </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extras</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_no_fields</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>bfields</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"No fields present"</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_dup_fields</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>duplicates</span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>bfields</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Duplicate field(s) "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Binding.print</span><span> </span><span class="entity"><span>dups</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>err_bad_fields</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>moreN</span></span><span> </span><span>o</span><span> </span><span>Binding.name_of</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bfields</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Illegal field name "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>moreN</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>err_dup_record</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>err_extra_frees</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>err_no_fields</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>err_dup_fields</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>err_bad_fields</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="entity"><span>errs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>definition</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span class="entity"><span>bfields</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cat_error</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Failed to define record "</span></span><span> </span><span>^</span><span> </span><span>Binding.print</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_record_cmd</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_parent</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Typedecl.read_constraint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_params</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Variable.declare_typ</span><span> </span><span>o</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_parent</span></span><span> </span><span class="entity"><span>raw_parent</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fields</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_fields</span></span><span> </span><span class="entity"><span>raw_fields</span></span><span> </span><span class="entity"><span>ctxt2</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.check_tfree</span><span> </span><span class="entity"><span>ctxt3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add_record</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="entity"><span>fields</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* printing *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_parent_recT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>unit</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parent</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>unit</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>the_parent_recT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>the_parent_recT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>the_parent_recT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a unit record scheme with parent: "</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_recT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moreT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_recT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>typ</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>moreT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a unit record scheme: "</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_recTs</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_parent_recT</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_recT_fields</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>drop</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>pfs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_field</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
          </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span>
        </span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Library.separate</span><span> </span><span class="main"><span>(</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.keyword1</span><span> </span><span class="inner_quoted"><span>"record"</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parent</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"+"</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
      </span><span>Pretty.fbrk</span><span> </span><span>::</span><span>
      </span><span>Pretty.fbreaks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_field</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_record</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_recT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown record: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>print_record</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_item</span></span><span> </span><span class="entity"><span>string_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span>Print_Mode.with_modes</span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Output.writeln</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>print_item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of_record</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* outer syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>record</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"define extensible record"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Spec.overloaded</span></span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Parse.type_args_constrained</span><span> </span><span>--</span><span> </span><span>Parse.binding</span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>=</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Parse.typ</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>+</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
        </span><span>Scan.repeat1</span><span> </span><span>Parse.const_binding</span><span class="main"><span>)</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>overloaded</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_record_cmd</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>overloaded</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>print_record</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"print record definiton"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>opt_modes</span></span><span> </span><span>--</span><span> </span><span>Parse.typ</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>print_record</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>