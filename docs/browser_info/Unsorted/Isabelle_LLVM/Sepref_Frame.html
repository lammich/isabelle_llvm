<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Sepref_Frame</title>
</head>


<body>
<div class="head">
<h1>Theory Sepref_Frame</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command"><span>section</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Frame Inference›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>theory</span></span></span><span> </span><a href="Sepref_Frame.html"><span>Sepref_Frame</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>imports</span></span></span><span> </span><a href="Sepref_Basic.html"><span>Sepref_Basic</span></a><span> </span><a href="Sepref_Constraints.html"><span>Sepref_Constraints</span></a><span>
</span><span class="keyword2"><span class="keyword"><span>begin</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹ In this theory, we provide a specific frame inference tactic
    for Sepref.

    The first tactic, </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>frame_tac</span></span><span class="antiquote"><span>}</span></span></span><span>, is a standard frame inference tactic, 
    based on the assumption that only </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span class="antiquote"><span>}</span></span></span><span>-assertions need to be
    matched.

    The second tactic, </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>merge_tac</span></span><span class="antiquote"><span>}</span></span></span><span>, resolves entailments of the form
      </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>"F1 ∨<span class="hidden">⇩</span><sub>A</sub> F2 ⟹<span class="hidden">⇩</span><sub>t</sub> ?F"</span></span><span class="antiquote"><span>}</span></span></span><span>
    that occur during translation of if and case statements.
    It synthesizes a new frame ?F, where refinements of variables 
    with equal refinements in </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>F1</span></span><span class="antiquote"><span>}</span></span></span><span> and </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>text</span></span><span> </span><span class="raw_text"><span>F2</span></span><span class="antiquote"><span>}</span></span></span><span> are preserved,
    and the others are set to </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span class="antiquote"><span>}</span></span></span><span>.
    ›</span></span></span><span>


</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.recover_pure_aux|fact"><span class="entity_def" id="Sepref_Frame.recover_pure_aux|thm"><span>recover_pure_aux</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure_conv|fact"><span>is_pure_conv</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.invalid_pure_recover|fact"><span>invalid_pure_recover</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span class="main"><span>)</span></span><span>



</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.frame_thms|fact"><span class="entity_def" id="Sepref_Frame.frame_thms(5)|thm"><span class="entity_def" id="Sepref_Frame.frame_thms(4)|thm"><span class="entity_def" id="Sepref_Frame.frame_thms(3)|thm"><span class="entity_def" id="Sepref_Frame.frame_thms(2)|thm"><span class="entity_def" id="Sepref_Frame.frame_thms(1)|thm"><span>frame_thms</span></span></span></span></span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span class="free"><span>P'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>F</span></span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span class="free"><span>F'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>F</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>P'</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>F'</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_val|const"><span>hn_val</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.UNIV|const"><span>UNIV</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span>"</span></span></span><span>  
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="operator"><span>-</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>applyS</span></span></span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>applyS</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="main"><span class="keyword3"><span>;</span></span></span><span> </span><span class="operator"><span>assumption</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>applyS</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>erule</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.recover_pure_aux|fact"><span>recover_pure_aux</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>applyS</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span class="main"><span class="keyword3"><span>,</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/HOL/Tools/SMT/smt_systems.ML.html#SMT.smt|method"><span class="operator"><span>smt</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails_def|fact"><span>entails_def</span></a><span> </span><a class="entity_ref" href="../../AFP/Automatic_Refinement/Relators.html#Relators.eq_UNIV_iff|fact"><span>eq_UNIV_iff</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pureE|fact"><span>is_pureE</span></a><span> </span><a class="entity_ref" href="Sep_Algebra_Add.html#Sep_Algebra_Add.pred_lift_def|fact"><span>pred_lift_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_app_eq|fact"><span>pure_app_eq</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>applyS</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.invalid_assn_def|fact"><span>invalid_assn_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure_iff_pure_assn|fact"><span>is_pure_iff_pure_assn</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>

</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_frame_match_rules|attribute"><span class="entity_def" id="Sepref_Frame.sepref_frame_match_rules|fact"><span>sepref_frame_match_rules</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Additional frame rules›</span></span><span>

</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Rules to discharge unmatched stuff›</span></span></span><span>
</span><span class="comment1"><span>(*lemma frame_rem_thms:
  "P ⟹<span class="hidden">⇩</span><sub>t</sub> P"
  "P ⟹<span class="hidden">⇩</span><sub>t</sub> emp"
  by sep_auto+
*)</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.frame_rem1|fact"><span class="entity_def" id="Sepref_Frame.frame_rem1|thm"><span>frame_rem1</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span class="free"><span>P</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.frame_rem2|fact"><span class="entity_def" id="Sepref_Frame.frame_rem2|thm"><span>frame_rem2</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>F</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>F'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span> </span><span class="free"><span>F</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>A</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span> </span><span class="free"><span>F'</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.frame_rem_thms|fact"><span class="entity_def" id="Sepref_Frame.frame_rem_thms(2)|thm"><span class="entity_def" id="Sepref_Frame.frame_rem_thms(1)|thm"><span>frame_rem_thms</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.frame_rem1|fact"><span>frame_rem1</span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.frame_rem2|fact"><span>frame_rem2</span></a><span>

</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_frame_rem_rules|attribute"><span class="entity_def" id="Sepref_Frame.sepref_frame_rem_rules|fact"><span>sepref_frame_rem_rules</span></span></span><span>
  </span><span class="quoted"><span>‹Sepref: Additional rules to resolve remainder of frame-pairing›</span></span><span>


</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.merge_thms|fact"><span class="entity_def" id="Sepref_Frame.merge_thms(5)|thm"><span class="entity_def" id="Sepref_Frame.merge_thms(4)|thm"><span class="entity_def" id="Sepref_Frame.merge_thms(3)|thm"><span class="entity_def" id="Sepref_Frame.merge_thms(2)|thm"><span class="entity_def" id="Sepref_Frame.merge_thms(1)|thm"><span>merge_thms</span></span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE_END|fact"><span>MERGE_END</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE_STAR|fact"><span>MERGE_STAR</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE1_eq|fact"><span>MERGE1_eq</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE1_invalids|fact"><span>MERGE1_invalids</span></a><span>
  
</span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_frame_merge_rules|attribute"><span class="entity_def" id="Sepref_Frame.sepref_frame_merge_rules|fact"><span>sepref_frame_merge_rules</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Additional merge rules›</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.free_thms|fact"><span class="entity_def" id="Sepref_Frame.free_thms(3)|thm"><span class="entity_def" id="Sepref_Frame.free_thms(2)|thm"><span class="entity_def" id="Sepref_Frame.free_thms(1)|thm"><span>free_thms</span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.mk_free_invalid|fact"><span>mk_free_invalid</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.mk_free_pure|fact"><span>mk_free_pure</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.mk_free_pair|fact"><span>mk_free_pair</span></a><span>
</span><span class="keyword1"><span class="command"><span>named_theorems_rev</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_frame_free_rules|attribute"><span class="entity_def" id="Sepref_Frame.sepref_frame_free_rules|fact"><span>sepref_frame_free_rules</span></span></span><span> </span><span class="quoted"><span>‹Sepref: Additional free rules›</span></span><span>


</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹These rules are applied to recover pure values that have been destroyed by rule application›</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Frame.RECOVER_PURE_def|fact"><span class="entity_def" id="Sepref_Frame.RECOVER_PURE_def|thm"><span class="entity_def" id="Sepref_Frame.RECOVER_PURE_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.recover_pure|fact"><span class="entity_def" id="Sepref_Frame.recover_pure(4)|thm"><span class="entity_def" id="Sepref_Frame.recover_pure(3)|thm"><span class="entity_def" id="Sepref_Frame.recover_pure(2)|thm"><span class="entity_def" id="Sepref_Frame.recover_pure(1)|thm"><span>recover_pure</span></span></span></span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="free"><span>P1</span></span><span> </span><span class="free"><span>Q1</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="free"><span>P2</span></span><span> </span><span class="free"><span>Q2</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P1</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>P2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>Q1</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Q2</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Constraints.html#Sepref_Constraints.CONSTRAINT|const"><span>CONSTRAINT</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.is_pure|const"><span>is_pure</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE_def|fact"><span>RECOVER_PURE_def</span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>drule</span></span><span> </span><span class="main"><span class="main"><span>(</span></span></span><span>1</span><span class="main"><span class="main"><span>)</span></span></span><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.recover_pure_aux|fact"><span>recover_pure_aux</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>
  
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.recover_pure_triv|fact"><span class="entity_def" id="Sepref_Frame.recover_pure_triv|thm"><span>recover_pure_triv</span></span></span><span class="main"><span>:</span></span><span> 
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE_def|fact"><span>RECOVER_PURE_def</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>


</span><span class="keyword1"><span class="command"><span>text</span></span></span><span> </span><span class="quoted"><span class="plain_text"><span>‹Weakening the postcondition by converting </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.invalid_assn|const"><span>invalid_assn</span></a><span class="antiquote"><span>}</span></span></span><span> to </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>λ</span></span><span class="main"><span class="bound"><span>_</span></span></span><span> </span><span class="main"><span class="bound"><span>_</span></span></span><span class="main"><span>.</span></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span>›</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Frame.WEAKEN_HNR_POST_def|fact"><span class="entity_def" id="Sepref_Frame.WEAKEN_HNR_POST_def|thm"><span class="entity_def" id="Sepref_Frame.WEAKEN_HNR_POST_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Γ</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Γ'</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Γ''</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Ex|const"><span>∃</span></a></span><span class="bound"><span>h</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Ex|const"><span>.</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Γ</span></span></span></span><span> </span><span class="bound"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.implies|const"><span>⟶</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span class="bound"><span class="entity"><span>Γ''</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Γ'</span></span></span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_2936..2941">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.weaken_hnr_postI|fact"><span class="entity_def" id="Sepref_Frame.weaken_hnr_postI|thm"><span>weaken_hnr_postI</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>Γ''</span></span><span> </span><span class="free"><span>Γ'</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ''</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine_preI|fact"><span>hn_refine_preI</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine_cons_post|fact"><span>hn_refine_cons_post</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#offset_2936..2941"><span>assms</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#offset_2936..2941"><span>assms</span></a><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST_def|fact"><span>WEAKEN_HNR_POST_def</span></a><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/blast.ML.html#HOL.blast|method"><span class="operator"><span>blast</span></span></a><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.weaken_hnr_post_triv|fact"><span class="entity_def" id="Sepref_Frame.weaken_hnr_post_triv|thm"><span>weaken_hnr_post_triv</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST_def|fact"><span>WEAKEN_HNR_POST_def</span></a><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.weaken_hnr_post|fact"><span class="entity_def" id="Sepref_Frame.weaken_hnr_post(3)|thm"><span class="entity_def" id="Sepref_Frame.weaken_hnr_post(2)|thm"><span class="entity_def" id="Sepref_Frame.weaken_hnr_post(1)|thm"><span>weaken_hnr_post</span></span></span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>⟦</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>P'</span></span><span class="main"><span>;</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="free"><span>Q'</span></span><span class="main"><span>⟧</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>Γ</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Γ'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>P'</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Q'</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST|const"><span>WEAKEN_HNR_POST</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_val|const"><span>hn_val</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/Set.html#Set.UNIV|const"><span>UNIV</span></a><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>proof</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>goal_cases</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="command"><span>case</span></span></span><span> </span><span>1</span><span> </span><span class="keyword3"><span class="command"><span>thus</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?case</span></span></span></span><span>
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST_def|fact"><span>WEAKEN_HNR_POST_def</span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.clarsimp|method"><span class="operator"><span>clarsimp</span></span></a><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="main"><span>)</span></span><span> 
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj_def|fact"><span>sep_conj_def</span></a><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command"><span>next</span></span></span><span>
  </span><span class="keyword3"><span class="command"><span>case</span></span></span><span> </span><span>2</span><span> </span><span class="keyword3"><span class="command"><span>thus</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?case</span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.weaken_hnr_post_triv|fact"><span>weaken_hnr_post_triv</span></a><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="command"><span>next</span></span></span><span>
  </span><span class="keyword3"><span class="command"><span>case</span></span></span><span> </span><span>3</span><span> </span><span class="keyword3"><span class="command"><span>thus</span></span></span><span> </span><span class="var"><span class="quoted"><span class="var"><span>?case</span></span></span></span><span> 
    </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.WEAKEN_HNR_POST_def|fact"><span>WEAKEN_HNR_POST_def</span></a><span> 
    </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.invalid_assn_def|fact"><span>invalid_assn_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt_def|fact"><span>hn_ctxt_def</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_def|fact"><span>pure_def</span></a><span> </span><a class="entity_ref" href="Sep_Algebra_Add.html#Sep_Algebra_Add.pure_partI|fact"><span>pure_partI</span></a><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="command"><span>qed</span></span></span><span>



</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_3932..3937">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.reorder_enttI|fact"><span class="entity_def" id="Sepref_Frame.reorder_enttI|thm"><span>reorder_enttI</span></span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>A</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>C</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>B</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>D</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>C</span></span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span class="free"><span>D</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>apply</span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>intro</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#offset_3932..3937"><span>assms</span></a><span class="main"><span>)</span></span><span>
  
  
</span><span class="comment1"><span>(*
lemma merge_sat1: "(A∨<span class="hidden">⇩</span><sub>A</sub>A' ⟹<span class="hidden">⇩</span><sub>t</sub> Am) ⟹ (A∨<span class="hidden">⇩</span><sub>A</sub>Am ⟹<span class="hidden">⇩</span><sub>t</sub> Am)"
  using entt_disjD1 entt_disjE by blast
lemma merge_sat2: "(A∨<span class="hidden">⇩</span><sub>A</sub>A' ⟹<span class="hidden">⇩</span><sub>t</sub> Am) ⟹ (Am∨<span class="hidden">⇩</span><sub>A</sub>A' ⟹<span class="hidden">⇩</span><sub>t</sub> Am)"
  using entt_disjD2 entt_disjE by blast
*)</span></span><span>


</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.merge_left_assn_cong|fact"><span class="entity_def" id="Sepref_Frame.merge_left_assn_cong|thm"><span>merge_left_assn_cong</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>L</span></span><span class="main"><span>≡</span></span><span class="free"><span>L'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="free"><span>L</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="free"><span>L'</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.merge_right_assn_cong|fact"><span class="entity_def" id="Sepref_Frame.merge_right_assn_cong|thm"><span>merge_right_assn_cong</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>R</span></span><span class="main"><span>≡</span></span><span class="free"><span>R'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="free"><span>L</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="free"><span>L</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="free"><span>R'</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.MERGE_append_END|fact"><span class="entity_def" id="Sepref_Frame.MERGE_append_END|thm"><span>MERGE_append_END</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="free"><span>L</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>L</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.FRI_END|const"><span>FRI_END</span></a><span class="main"><span>)</span></span><span> </span><span class="free"><span>frl</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>R</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.FRI_END|const"><span>FRI_END</span></a><span class="main"><span>)</span></span><span> </span><span class="free"><span>frr</span></span><span> </span><span class="free"><span>Q</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.FRI_END_def|fact"><span>FRI_END_def</span></a><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Frame.FR_SOLVE_SIMPLE_def|fact"><span class="entity_def" id="Sepref_Frame.FR_SOLVE_SIMPLE_def|thm"><span class="entity_def" id="Sepref_Frame.FR_SOLVE_SIMPLE_def_raw|axiom"><span>definition</span></span></span></span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span class="entity_def" id="Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P'</span></span></span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q'</span></span></span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>P</span></span></span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span class="bound"><span class="entity"><span>P'</span></span></span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span class="bound"><span class="entity"><span>Q</span></span></span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span class="bound"><span class="entity"><span>Q'</span></span></span></span><span>"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.fr_solve_simple_init|fact"><span class="entity_def" id="Sepref_Frame.fr_solve_simple_init|thm"><span>fr_solve_simple_init</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>Ps</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>Qs</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>Ps</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>Qs</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.fr_solve_simple_match|fact"><span class="entity_def" id="Sepref_Frame.fr_solve_simple_match|thm"><span>fr_solve_simple_match</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="free"><span>Ps</span></span><span> </span><span class="free"><span>Qs</span></span><span> </span><span class="free"><span>Ps'</span></span><span> </span><span class="free"><span>Qs'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Qs</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>Ps'</span></span><span> </span><span class="free"><span>Qs'</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.fr_solve_simple_nomatch|fact"><span class="entity_def" id="Sepref_Frame.fr_solve_simple_nomatch|thm"><span>fr_solve_simple_nomatch</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="free"><span>Ps</span></span><span> </span><span class="free"><span>Qs</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>Ps'</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>Qs'</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>P</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>Q</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>Qs</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>Ps'</span></span><span> </span><span class="free"><span>Qs'</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.fr_solve_simple_finalize|fact"><span class="entity_def" id="Sepref_Frame.fr_solve_simple_finalize|thm"><span>fr_solve_simple_finalize</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>Ps'</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="free"><span>Qs'</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE|const"><span>FR_SOLVE_SIMPLE</span></a><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_empty|const"><span>□</span></a></span><span> </span><span class="free"><span>Ps'</span></span><span> </span><span class="free"><span>Qs'</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>unfolding</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.FR_SOLVE_SIMPLE_def|fact"><span>FR_SOLVE_SIMPLE_def</span></a><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep.mult_commute|fact"><span>sep.mult_commute</span></a><span> </span><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj_left_commute|fact"><span>sep_conj_left_commute</span></a><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>subgoal</span></span></span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="operator"><span>simp</span></span><span>
  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command"><span>done</span></span></span></span></span><span>
  
</span><span class="keyword1"><span class="command"><span>named_simpset</span></span></span><span> </span><span>sepref_frame_normrel</span><span> </span><span class="main"><span>=</span></span><span> </span><span>HOL_basic_ss_nomatch</span><span>
</span><span class="keyword1"><span class="command"><span>named_theorems</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_frame_normgoal_intros|attribute"><span class="entity_def" id="Sepref_Frame.sepref_frame_normgoal_intros|fact"><span>sepref_frame_normgoal_intros</span></span></span><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.sepref_frame_normgoal_intros|attribute"><span class="operator"><span>sepref_frame_normgoal_intros</span></span></a><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.impI|fact"><span>impI</span></a><span>

  
</span><span class="keyword1"><span class="command"><span>ML</span></span></span><span> </span><span class="quoted"><span>‹
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SEPREF_FRAME</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>


  </span><span class="comment1"><span>(* Check if subgoal is a frame obligation *)</span></span><span>
  </span><span class="comment1"><span>(*val is_frame : term -&gt; bool *)</span></span><span>
  </span><span class="comment1"><span>(* Check if subgoal is a merge obligation *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_merge</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="comment1"><span>(* Perform frame inference *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> frame_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="comment1"><span>(* Perform merging *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> merge_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

  </span><span class="comment1"><span>(* Perform free synthesis *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> free_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> frame_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

  </span><span class="comment1"><span>(* Reorder frame *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_frame_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="comment1"><span>(* Solve a RECOVER_PURE goal, inserting constraints as necessary *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> recover_pure_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

  </span><span class="comment1"><span>(* Split precondition of hnr-goal into frame and arguments *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> align_goal_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="comment1"><span>(* Normalize goal's precondition *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_goal_pre_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>
  </span><span class="comment1"><span>(* Rearrange precondition of hnr-term according to parameter order, normalize all relations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> align_rl_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>

  </span><span class="comment1"><span>(* Convert hn_invalid to hn_val UNIV in postcondition of hnr-goal. Makes proving the goal easier.*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> weaken_post_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>tactic'</span></span><span>

  </span><span class="comment1"><span>(*
  val add_normrel_eq : thm -&gt; Context.generic -&gt; Context.generic
  val del_normrel_eq : thm -&gt; Context.generic -&gt; Context.generic
  val get_normrel_eqs : Proof.context -&gt; thm list
  *)</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cfg_debug</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sepref_Frame</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SEPREF_FRAME</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>binding</span></span><span> </span><span class="entity_def" id="Sepref_Frame.sepref_debug_frame|attribute"><span>sepref_debug_frame</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>DCONVERSION</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Debugging.DBG_CONVERSION</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Debugging.dbg_msg_tac</span></span><span> </span><span class="entity"><span>cfg_debug</span></span><span>

</span><span class="comment1"><span>(*
  structure normrel_eqs = Named_Thms (
    val name = @{binding sepref_frame_normrel_eqs}
    val description = "Equations to normalize relations for frame matching"
  )

  val add_normrel_eq = normrel_eqs.add_thm
  val del_normrel_eq = normrel_eqs.del_thm
  val get_normrel_eqs = normrel_eqs.get
*)</span></span><span>
  </span><span class="comment1"><span>(*val mk_entails = HOLogic.mk_binrel @{const_name "entails"}*)</span></span><span>


  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sepref_Basic</span><span> </span><span>Refine_Util</span><span> </span><span>Conv</span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assn_ord</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>dest_hn_ctxt_opt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>EQUAL</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>LESS</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>GREATER</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term_Ord.fast_term_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reorder_ctxt_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> 
        </span><span>|&gt;</span><span> </span><span class="entity"><span>strip_star</span></span><span>
        </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="entity"><span>assn_ord</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>list_star</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>cert</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_cequals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span class="entity"><span>new_ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>VCG_Lib.simp_only_tac</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sep_Algebra_Add.html#Sep_Algebra_Add.sep_conj_aci|fact"><span>sep_conj_aci</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_fi_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><span class="var"><span>?P</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="var"><span>?Q</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="comment1"><span>(* Build table from abs-vars to ctxt *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Qum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_star</span></span><span> </span><span class="entity"><span>Q</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_true</span></span><span> </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>is_hn_ctxt</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Qtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>Qm</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_hn_ctxt</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
          </span><span>|&gt;</span><span> </span><span>Termtab.make</span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
            </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Termtab.DUP</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Dup heap: "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="comment1"><span>(* Go over entries in P and try to find a partner *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_hn_ctxt_opt</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span>::</span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>Qtab</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="entity"><span>tg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>tg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span>::</span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_star</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qtab</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Pum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_true</span></span><span> </span><span class="entity"><span>Pum</span></span><span>

        </span><span class="comment1"><span>(* Read out information from Qtab *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pairs</span></span><span class="main"><span>,</span></span><span class="entity"><span>Qum2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.dest</span><span> </span><span class="entity"><span>Qtab</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> 
          </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>the</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
  
        </span><span class="comment1"><span>(* Build reordered terms: P' = fst pairs * Pum, Q' = snd pairs * (Qum2*Qum) *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_star</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list_star</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>list_star</span></span><span> </span><span class="entity"><span>Pum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Q'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_star</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list_star</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>list_star</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qum2</span></span><span>@</span><span class="entity"><span>Qum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_entails</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Q'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>new_t</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>goal_t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>msg_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dbg_msg_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Debugging.msg_allgoals</span></span><span> </span><span class="inner_quoted"><span>"Solving frame permutation"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>msg_tac</span></span><span> </span><span>THEN</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.reorder_enttI|fact"><span>reorder_enttI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>star_permute_tac</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal_t</span></span><span>
        
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_ct</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>
  
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> 
        </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_conv</span><span> </span><span class="entity"><span>ct</span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> 
    </span><span class="entity"><span>is_merge</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE|const"><span>MERGE</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> 
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_merge</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MERGE1|const"><span>MERGE1</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> 
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_merge</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_frame</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.entails|const"><span>⊢</span></a></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_frame</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.MK_FREE|const"><span>MK_FREE</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    

    

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_frame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span> </span><span>Conv</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span> </span><span>THEN'</span><span>
    </span><span class="comment1"><span>(*CONCL_COND' is_frame THEN'*)</span></span><span>
    </span><span class="entity"><span>Frame_Infer.simp_ai_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
    </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_fi_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>    


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_free_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.free_thms|fact"><span>free_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span>
      </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_frame_free_rules</span><span class="antiquote"><span>}</span></span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>REPEAT'</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>free_thms</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span>ORELSE'</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>TRY_SOLVED'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOLVED'</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>side_tac</span></span><span>  
    </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wrap_side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>THEN_ALL_NEW_FWD</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>CASES'</span></span><span> </span><span class="main"><span>[</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_frame</span></span><span class="main"><span>,</span></span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_merge</span></span><span class="main"><span>,</span></span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_free</span></span><span class="main"><span>,</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>TRY_SOLVED'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOLVED'</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_free_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>all_tac</span><span class="main"><span>,</span></span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>TRY_SOLVED'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOLVED'</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>side_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>frame_step_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span> </span><span>Conv</span><span>

      </span><span class="comment1"><span>(* Constraint solving is built-in *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sepref_Constraints.constraint_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.frame_thms|fact"><span>frame_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span>
        </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_frame_match_rules</span><span class="antiquote"><span>}</span></span></span><span> 
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.merge_thms|fact"><span>merge_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span>
        </span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> sepref_frame_merge_rules</span><span class="antiquote"><span>}</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Simpsets.put</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_simpset</span></span><span> </span><span>sepref_frame_normrel</span><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>frame_thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wrap_side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frame_thms</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wrap_side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>merge_thms</span></span><span class="main"><span>)</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_merge</span></span><span> </span><span class="entity"><span>THEN_ELSE'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame_thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>full_simp_tac</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>THEN'</span><span> </span><span class="entity"><span>thm_tac</span></span><span> </span><span class="entity"><span>dbg</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>frame_solve_simple_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.fr_solve_simple_init|fact"><span>fr_solve_simple_init</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>THEN'</span><span> </span><span class="entity"><span>Frame_Infer.simp_a_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>THEN'</span><span> </span><span class="entity"><span>REPEAT_DETERM'</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.fr_solve_simple_match|fact"><span>fr_solve_simple_match</span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.fr_solve_simple_nomatch|fact"><span>fr_solve_simple_nomatch</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.fr_solve_simple_finalize|fact"><span>fr_solve_simple_finalize</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>THEN'</span><span> </span><span class="entity"><span>Frame_Infer.simp_ai_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>frame_loop_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_merge</span></span><span> </span><span class="entity"><span>THEN_ELSE'</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>all_tac</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frame_solve_simple_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> 
    </span><span>THEN'</span><span> </span><span>TRY</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>frame_step_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>frame_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span> </span><span>Conv</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frame_rem_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.frame_rem_thms|fact"><span>frame_rem_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>@</span><span> </span><span class="entity"><span>Named_Theorems_Rev.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems_rev</span></span><span> sepref_frame_rem_rules</span><span class="antiquote"><span>}</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_remainder_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TRY</span><span> </span><span>o</span><span> </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frame_rem_thms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>prepare_frame_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>THEN'</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Frame_Infer.html#Frame_Infer.conj_entails_mono|fact"><span>conj_entails_mono</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>THEN_ALL_NEW_LIST</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span class="entity"><span>frame_loop_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>solve_remainder_tac</span></span><span>
    </span><span class="main"><span>]</span></span><span>  
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Refine_Util</span><span> </span><span>Conv</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reord_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Fri_Extract.cong_rl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reorder_ctxt_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.merge_left_assn_cong|fact"><span>merge_left_assn_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
           </span><span>then_conv</span><span> </span><span class="entity"><span>Fri_Extract.cong_rl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reorder_ctxt_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.merge_right_assn_cong|fact"><span>merge_right_assn_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
           
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>Frame_Infer.rewrite_a_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>then_conv</span><span> </span><span class="entity"><span>reord_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>then_conv</span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.MERGE_append_END|fact"><span>MERGE_append_END</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>then_conv</span><span> </span><span class="entity"><span>Frame_Infer.rewrite_a_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span> </span><span>THEN'</span><span>
    </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_merge</span></span><span> </span><span>THEN'</span><span>
    </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN'</span><span>
    </span><span class="entity"><span>frame_loop_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_tac</span></span><span> </span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span>CONVERSION</span><span> </span><span>Thm.eta_conversion</span><span> </span><span>THEN'</span><span>
    </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span>THEN'</span><span>
    </span><span class="entity"><span>mk_free_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>side_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sepref_Basic</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_invalid</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalid|const"><span>hn_invalid</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.assn|type"><span>assn</span></a><span>"</span></span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_invalid</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>contains_invalid</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.RECOVER_PURE|const"><span>RECOVER_PURE</span></a><span> </span><span class="var"><span>?Q</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_invalid</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_star</span></span><span> </span><span class="entity"><span>Q</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>contains_invalid</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>recover_pure_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>contains_invalid</span></span><span> </span><span class="entity"><span>THEN_ELSE'</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.recover_pure|fact"><span>recover_pure</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>Sepref_Constraints.constraint_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.recover_pure_triv|fact"><span>recover_pure_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sepref_Basic</span><span> </span><span>Refine_Util</span><span>
    </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cte</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Other</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term * term * term
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_ctxt_elem</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mpat</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?a</span></span><span> </span><span class="var"><span>?c</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_ctxt_elem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Other</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctxt_elem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Other</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span> 
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_ctxt_elem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Hn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>mk_term</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_ctxt|const"><span>hn_ctxt</span></a><span> </span><span class="var"><span>?R</span></span><span> </span><span class="var"><span>?a</span></span><span> </span><span class="var"><span>?c</span></span><span>"</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Hn</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>y</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_with_frame</span></span><span> </span><span class="comment1"><span>(*ctxt*)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_hn_refine</span></span><span> </span><span class="entity"><span>t</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_hnr_absfun</span></span><span> </span><span class="entity"><span>a</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pre_ctes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_star</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>dest_ctxt_elem</span></span><span>

        
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>split_matching</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>pre_ctes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"align_conv: Could not match all arguments"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_goal_conv_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_with_frame</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>list_star</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_ctxt_elem</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_star</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_hn_refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P'</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_rl_conv_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pre_args</span></span><span class="main"><span>,</span></span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_with_frame</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"align_rl_conv: Extra preconditions in rule"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>list_star</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_ctxt_elem</span></span><span> </span><span class="entity"><span>frame</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_star</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_ctxt_elem</span></span><span> </span><span class="entity"><span>pre_args</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_hn_refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P'</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>Q</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span class="entity"><span>CP</span></span><span class="main"><span>,</span></span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  


    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normrel_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Simpsets.put</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_simpset</span></span><span> </span><span>sepref_frame_normrel</span><span class="antiquote"><span>}</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ss</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_goal_pre_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normrel_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
        </span><span class="entity"><span>hn_refine_conv</span></span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span>all_conv</span><span> </span><span>all_conv</span><span> </span><span>all_conv</span><span> </span><span>all_conv</span><span> </span><span>all_conv</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
    
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_goal_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f_tac_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>align_goal_conv_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>star_permute_tac</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_goal_pre_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm_goal_pre_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>THEN'</span><span> </span><span class="entity"><span>REPEAT_DETERM'</span></span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>named_theorems</span></span><span> sepref_frame_normgoal_intros</span><span class="antiquote"><span>}</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_rl_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normrel_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>hn_refine_conv</span></span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span>all_conv</span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span class="entity"><span>nr_conv</span></span><span> </span><span>all_conv</span><span> </span><span>all_conv</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f_tac_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>align_rl_conv_aux</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>star_permute_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>then_conv</span><span> </span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align_goal_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="entity"><span>CONCL_COND'</span></span><span> </span><span class="entity"><span>is_hn_refine_concl</span></span><span> 
      </span><span class="comment1"><span>(*THEN' norm_goal_pre_tac ctxt*)</span></span><span>
      </span><span>THEN'</span><span> </span><span class="entity"><span>DCONVERSION</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOL_concl_conv</span></span><span> </span><span class="entity"><span>align_goal_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>weaken_post_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TRADE</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.weaken_hnr_postI|fact"><span>weaken_hnr_postI</span></a><span class="antiquote"><span>}</span></span></span></span><span> 
    </span><span>THEN'</span><span> </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.weaken_hnr_post|fact"><span>weaken_hnr_post</span></a><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.weaken_hnr_post_triv|fact"><span>weaken_hnr_post_triv</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
›</span></span><span>

</span><span class="keyword1"><span class="command"><span>setup</span></span></span><span> </span><span class="entity"><span>Sepref_Frame.setup</span></span><span>

</span><span class="keyword1"><span class="command"><span>method_setup</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.weaken_hnr_post|method"><span>weaken_hnr_post</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="quoted"><span>‹</span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sepref_Frame.weaken_post_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>›</span></span><span>
  </span><span class="quoted"><span>‹Convert "hn_invalid" to "hn_ctxt (λ_ _. true)" in postcondition of hn_refine goal›</span></span><span>

</span><span class="keyword1"><span class="command"><span>lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.mod_starD|fact"><span class="entity_def" id="Sepref_Frame.mod_starD|thm"><span>mod_starD</span></span></span><span class="main"><span>:</span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="free"><span>A</span></span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span class="free"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>h</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Ex|const"><span>∃</span></a></span><span class="bound"><span>h1</span></span><span> </span><span class="bound"><span>h2</span></span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.Ex|const"><span>.</span></a></span><span> </span><span class="free"><span>A</span></span><span> </span><span class="bound"><span>h1</span></span><span> </span><span class="main"><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conj|const"><span>∧</span></a></span><span> </span><span class="free"><span>B</span></span><span> </span><span class="bound"><span>h2</span></span><span class="main"><span>)</span></span><span>"</span></span></span><span> </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/clasimp.ML.html#HOL.auto|method"><span class="operator"><span>auto</span></span></a><span> </span><span class="quasi_keyword"><span>simp</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj_def|fact"><span>sep_conj_def</span></a><span class="main"><span>)</span></span><span> 
  
</span><span class="comment1"><span>(* TODO: Improper, modifies all h⊨_ premises that happen to be there. Use tagging to protect! *)</span></span><span>
</span><span class="keyword1"><span class="command"><span class="entity_def" id="Sepref_Frame.extract_hnr_invalids.extract_hnr_invalids|method"><span>method</span></span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.extract_hnr_invalids|method"><span>extract_hnr_invalids</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><a class="entity_ref" href="../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine_preI|fact"><span>hn_refine_preI</span></a><span class="main"><span class="keyword3"><span>,</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><a class="entity_ref" href="../../AFP/Automatic_Refinement/HOL-Eisbach.Eisbach.html#Eisbach.determ|method"><span class="operator"><span>determ</span></span></a><span> </span><span class="quoted"><span>‹</span><span class="operator"><span>drule</span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.mod_starD|fact"><span>mod_starD</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_invalidI|fact"><span>hn_invalidI</span></a><span> </span><span class="main"><span class="keyword3"><span>|</span></span></span><span> </span><span class="operator"><span>elim</span></span><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.conjE|fact"><span>conjE</span></a><span> </span><a class="entity_ref" href="../../HOL/HOL/HOL.html#HOL.exE|fact"><span>exE</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span class="keyword3"><span>+</span></span></span><span class="main"><span>)</span></span><span class="main"><span class="keyword3"><span>?</span></span></span><span>
</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>― ‹Extract </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>hn_invalid _ _ _ = true›</span></span></span><span> preconditions from </span><span class="antiquoted"><span class="raw_text"><span class="operator"><span>‹</span></span><span>hn_refine›</span></span></span><span> goal.›</span></span><span>
  

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="USER_HOME/devel/isabelle/isabelle_llvm_2023/thys/lib/named_simpsets.ML.html#Named_Simpsets.named_ss|attribute"><span class="operator"><span>named_ss</span></span></a><span> </span><span>sepref_frame_normrel</span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj_assoc|fact"><span>sep_conj_assoc</span></a><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="USER_HOME/devel/isabelle/isabelle_llvm_2023/thys/lib/named_simpsets.ML.html#Named_Simpsets.named_ss|attribute"><span class="operator"><span>named_ss</span></span></a><span> </span><span>sepref_frame_normrel</span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.the_pure_pure|fact"><span>the_pure_pure</span></a><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.pure_the_pure|fact"><span>pure_the_pure</span></a><span>

</span><span class="keyword1"><span class="command"><span>lemmas</span></span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="USER_HOME/devel/isabelle/isabelle_llvm_2023/thys/lib/named_simpsets.ML.html#Named_Simpsets.named_ss|attribute"><span class="operator"><span>named_ss</span></span></a><span> </span><span>sepref_frame_normrel</span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><a class="entity_ref" href="Sep_Algebra_Add.html#Sep_Algebra_Add.pred_lift_move_merge_simps|fact"><span>pred_lift_move_merge_simps</span></a><span>

</span><span class="keyword1"><span class="command"><span class="entity_def" id="offset_18318..18323">lemma</span></span></span><span> </span><span class="entity_def" id="Sepref_Frame.hnr_pre_pureI|fact"><span class="entity_def" id="Sepref_Frame.hnr_pre_pureI|thm"><span>hnr_pre_pureI</span></span></span><span class="main"><span>[</span></span><a class="entity_ref" href="Sepref_Frame.html#Sepref_Frame.sepref_frame_normgoal_intros|attribute"><span class="operator"><span>sepref_frame_normgoal_intros</span></span></a><span class="main"><span>]</span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>assumes</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><span class="free"><span>Φ</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="free"><span>Γ</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>shows</span></span></span><span> </span><span class="quoted"><span class="quoted"><span>"</span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hn_refine|const"><span>hn_refine</span></a><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="Sep_Algebra_Add.html#Sep_Algebra_Add.pred_lift|const"><span>↑</span></a></span><span class="free"><span>Φ</span></span><span> </span><span class="main"><a class="entity_ref" href="Separation_Algebra.Separation_Algebra.html#Separation_Algebra.sep_algebra_class.sep_conj|const"><span>**</span></a></span><span> </span><span class="free"><span>Γ</span></span><span class="main"><span>)</span></span><span> </span><span class="free"><span>c</span></span><span> </span><span class="free"><span>Γ'</span></span><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>CP</span></span><span> </span><span class="free"><span>a</span></span><span>"</span></span></span><span>
  </span><span class="keyword1"><span class="command"><span>using</span></span></span><span> </span><a class="entity_ref" href="Sepref_Frame.html#offset_18318..18323"><span>assms</span></a><span>
  </span><span class="keyword1"><span class="command"><span>by</span></span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span class="main"><span>:</span></span></span><span> </span><a class="entity_ref" href="Sepref_Basic.html#Sepref_Basic.hnr_pre_pure_conv|fact"><span>hnr_pre_pure_conv</span></a><span class="main"><span>)</span></span><span>



</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span></pre>
</body>

</html>